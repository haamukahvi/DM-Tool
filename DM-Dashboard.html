<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DM Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #0a0a0f;
      --bg-panel: #13131a;
      --bg-panel-2: #181823;
      --text: #e2e8f0;
      --muted: rgba(226, 232, 240, 0.5);
      --accent: #ec4899;
      --accent-2: #8b5cf6;
      --accent-3: #22d3ee;
      --outline: rgba(255, 255, 255, 0.08);
    }

    body {
      margin: 0;
      font-family: 'Exo 2', sans-serif;
      background: radial-gradient(circle at 15% 20%, #151525 0%, #0b0b12 40%, #0a0a0f 100%);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .title-font {
      font-family: 'Exo 2', sans-serif;
      letter-spacing: 0.08em;
    }

    .panel-glow {
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .ambient-bg {
      background-image:
        radial-gradient(circle at 20% 10%, rgba(236, 72, 153, 0.15), transparent 45%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.12), transparent 50%);
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0a0a0f;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 999px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .custom-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes flash {
      0% { background-color: rgba(255, 255, 255, 0.05); }
      50% { background-color: rgba(255, 255, 255, 0.2); }
      100% { background-color: rgba(255, 255, 255, 0.05); }
    }

    .animate-fade-in-up {
      animation: fade-in-up 0.3s ease both;
    }

    .animate-flash {
      animation: flash 0.6s ease;
    }

    .gradient-text {
      background: linear-gradient(270deg, #d100ff, #7a00ff, #00c3ff, #d100ff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-flow 10s linear infinite;
    }

    @keyframes gradient-flow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes critical-pulse {
      0%, 100% { text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
      50% { text-shadow: 0 0 40px #00bfff, 0 0 80px #00bfff; }
    }

    .critical-label {
      animation: critical-pulse 2.5s ease-in-out infinite;
    }

    @keyframes breathe-opacity {
      0%, 100% { opacity: 0.25; }
      50% { opacity: 0.6; }
    }

    .animate-breathe {
      animation: breathe-opacity 4s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const IconBase = ({ children, className, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" className={className} {...props}>
        {children}
      </svg>
    );

    const Music = (props) => (
      <IconBase {...props}>
        <path d="M17 2a3 3 0 0 1 3 3v14a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3v-14a3 3 0 0 1 3 -3zm-5 9a4 4 0 0 0 -3.995 3.8l-.005 .2a4 4 0 1 0 4 -4m0 -5a1 1 0 0 0 -1 1v.01a1 1 0 0 0 2 0v-.01a1 1 0 0 0 -1 -1" />
      </IconBase>
    );

    const Dice = (props) => (
      <IconBase {...props}>
        <path d="M18.333 2c1.96 0 3.56 1.537 3.662 3.472l.005 .195v12.666c0 1.96 -1.537 3.56 -3.472 3.662l-.195 .005h-12.666a3.667 3.667 0 0 1 -3.662 -3.472l-.005 -.195v-12.666c0 -1.96 1.537 -3.56 3.472 -3.662l.195 -.005h12.666zm-2.833 12a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3m-7 0a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3m3.5 -3.5a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3m-3.5 -3.5a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3m7 0a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0 -3" />
      </IconBase>
    );

    const Sparkles = (props) => (
      <IconBase {...props}>
        <path d="M17.657 12.007a1.39 1.39 0 0 0 -1.103 .765l-.855 1.723l-1.907 .277c-.52 .072 -.96 .44 -1.124 .944l-.038 .14c-.1 .465 .046 .954 .393 1.29l1.377 1.337l-.326 1.892a1.393 1.393 0 0 0 2.018 1.465l1.708 -.895l1.708 .896a1.388 1.388 0 0 0 1.462 -.105l.112 -.09a1.39 1.39 0 0 0 .442 -1.272l-.325 -1.891l1.38 -1.339c.38 -.371 .516 -.924 .352 -1.427l-.051 -.134a1.39 1.39 0 0 0 -1.073 -.81l-1.907 -.278l-.853 -1.722a1.393 1.393 0 0 0 -1.247 -.773l-.143 .007z" />
        <path d="M6.057 12.007a1.39 1.39 0 0 0 -1.103 .765l-.855 1.723l-1.907 .277c-.52 .072 -.96 .44 -1.124 .944l-.038 .14c-.1 .465 .046 .954 .393 1.29l1.377 1.337l-.326 1.892a1.393 1.393 0 0 0 2.018 1.465l1.708 -.895l1.708 .896a1.388 1.388 0 0 0 1.462 -.105l.112 -.09a1.39 1.39 0 0 0 .442 -1.272l-.324 -1.891l1.38 -1.339c.38 -.371 .516 -.924 .352 -1.427l-.051 -.134a1.39 1.39 0 0 0 -1.073 -.81l-1.908 -.279l-.853 -1.722a1.393 1.393 0 0 0 -1.247 -.772l-.143 .007z" />
        <path d="M11.857 2.007a1.39 1.39 0 0 0 -1.103 .765l-.855 1.723l-1.907 .277c-.52 .072 -.96 .44 -1.124 .944l-.038 .14c-.1 .465 .046 .954 .393 1.29l1.377 1.337l-.326 1.892a1.393 1.393 0 0 0 2.018 1.465l1.708 -.894l1.709 .896a1.388 1.388 0 0 0 1.462 -.105l.112 -.09a1.39 1.39 0 0 0 .442 -1.272l-.325 -1.892l1.38 -1.339c.38 -.371 .516 -.924 .352 -1.427l-.051 -.134a1.39 1.39 0 0 0 -1.073 -.81l-1.908 -.279l-.853 -1.722a1.393 1.393 0 0 0 -1.247 -.772l-.143 .007z" />
      </IconBase>
    );

    const FileText = (props) => (
      <IconBase {...props}>
        <path d="M12 2l.117 .007a1 1 0 0 1 .876 .876l.007 .117v4l.005 .15a2 2 0 0 0 1.838 1.844l.157 .006h4l.117 .007a1 1 0 0 1 .876 .876l.007 .117v9a3 3 0 0 1 -2.824 2.995l-.176 .005h-10a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-14a3 3 0 0 1 2.824 -2.995l.176 -.005zm3 14h-6a1 1 0 0 0 0 2h6a1 1 0 0 0 0 -2m0 -4h-6a1 1 0 0 0 0 2h6a1 1 0 0 0 0 -2m-5 -4h-1a1 1 0 1 0 0 2h1a1 1 0 0 0 0 -2" />
        <path d="M19 7h-4l-.001 -4.001z" />
      </IconBase>
    );

    const Sliders = (props) => (
      <IconBase {...props}>
        <path d="M6 3a1 1 0 0 1 .993 .883l.007 .117v3.171a3.001 3.001 0 0 1 0 5.658v7.171a1 1 0 0 1 -1.993 .117l-.007 -.117v-7.17a3.002 3.002 0 0 1 -1.995 -2.654l-.005 -.176l.005 -.176a3.002 3.002 0 0 1 1.995 -2.654v-3.17a1 1 0 0 1 1 -1z" />
        <path d="M12 3a1 1 0 0 1 .993 .883l.007 .117v9.171a3.001 3.001 0 0 1 0 5.658v1.171a1 1 0 0 1 -1.993 .117l-.007 -.117v-1.17a3.002 3.002 0 0 1 -1.995 -2.654l-.005 -.176l.005 -.176a3.002 3.002 0 0 1 1.995 -2.654v-9.17a1 1 0 0 1 1 -1z" />
        <path d="M18 3a1 1 0 0 1 .993 .883l.007 .117v.171a3.001 3.001 0 0 1 0 5.658v10.171a1 1 0 0 1 -1.993 .117l-.007 -.117v-10.17a3.002 3.002 0 0 1 -1.995 -2.654l-.005 -.176l.005 -.176a3.002 3.002 0 0 1 1.995 -2.654v-.17a1 1 0 0 1 1 -1z" />
      </IconBase>
    );

    const RefreshCw = (props) => (
      <IconBase {...props}>
        <path d="M12 2c5.523 0 10 4.477 10 10a10 10 0 0 1 -20 0l.004 -.28c.148 -5.393 4.566 -9.72 9.996 -9.72m-.293 13.293a1 1 0 0 0 -1.414 1.414l1 1a1 1 0 0 0 1.414 0l1 -1a1 1 0 0 0 0 -1.414l-.094 -.083a1 1 0 0 0 -1.32 .083l-.293 .292zm-3 -5a1 1 0 0 0 -1.414 0l-1 1a1 1 0 0 0 0 1.414l1 1a1 1 0 0 0 1.414 0l.083 -.094a1 1 0 0 0 -.083 -1.32l-.292 -.293l.292 -.293a1 1 0 0 0 0 -1.414m8 0a1 1 0 0 0 -1.414 0l-.083 .094a1 1 0 0 0 .083 1.32l.292 .292l-.292 .294a1 1 0 0 0 1.414 1.414l1 -1a1 1 0 0 0 0 -1.414zm-4 -4a1 1 0 0 0 -1.414 0l-1 1a1 1 0 0 0 0 1.414l.094 .083a1 1 0 0 0 1.32 -.083l.293 -.292l.293 .292a1 1 0 0 0 1.414 -1.414z" />
      </IconBase>
    );

    const Minus = (props) => (
      <IconBase {...props}>
        <path d="M12 2l.324 .001l.318 .004l.616 .017l.299 .013l.579 .034l.553 .046c4.785 .464 6.732 2.411 7.196 7.196l.046 .553l.034 .579c.005 .098 .01 .198 .013 .299l.017 .616l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.464 4.785 -2.411 6.732 -7.196 7.196l-.553 .046l-.579 .034c-.098 .005 -.198 .01 -.299 .013l-.616 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.785 -.464 -6.732 -2.411 -7.196 -7.196l-.046 -.553l-.034 -.579a28.058 28.058 0 0 1 -.013 -.299l-.017 -.616c-.003 -.21 -.005 -.424 -.005 -.642l.001 -.324l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.464 -4.785 2.411 -6.732 7.196 -7.196l.553 -.046l.579 -.034c.098 -.005 .198 -.01 .299 -.013l.616 -.017c.21 -.003 .424 -.005 .642 -.005zm3 9h-6l-.117 .007a1 1 0 0 0 .117 1.993h6l.117 -.007a1 1 0 0 0 -.117 -1.993z" />
      </IconBase>
    );

    const Plus = (props) => (
      <IconBase {...props}>
        <path d="M12 2l.324 .001l.318 .004l.616 .017l.299 .013l.579 .034l.553 .046c4.785 .464 6.732 2.411 7.196 7.196l.046 .553l.034 .579c.005 .098 .01 .198 .013 .299l.017 .616l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.464 4.785 -2.411 6.732 -7.196 7.196l-.553 .046l-.579 .034c-.098 .005 -.198 .01 -.299 .013l-.616 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.785 -.464 -6.732 -2.411 -7.196 -7.196l-.046 -.553l-.034 -.579a28.058 28.058 0 0 1 -.013 -.299l-.017 -.616c-.003 -.21 -.005 -.424 -.005 -.642l.001 -.324l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.464 -4.785 2.411 -6.732 7.196 -7.196l.553 -.046l.579 -.034c.098 -.005 .198 -.01 .299 -.013l.616 -.017c.21 -.003 .424 -.005 .642 -.005zm0 6a1 1 0 0 0 -1 1v2h-2l-.117 .007a1 1 0 0 0 .117 1.993h2v2l.007 .117a1 1 0 0 0 1.993 -.117v-2h2l.117 -.007a1 1 0 0 0 -.117 -1.993h-2v-2l-.007 -.117a1 1 0 0 0 -.993 -.883z" fill="currentColor" strokeWidth="0" />
      </IconBase>
    );

    const Settings = (props) => (
      <IconBase {...props}>
        <path d="M14.647 4.081a.724 .724 0 0 0 1.08 .448c2.439 -1.485 5.23 1.305 3.745 3.744a.724 .724 0 0 0 .447 1.08c2.775 .673 2.775 4.62 0 5.294a.724 .724 0 0 0 -.448 1.08c1.485 2.439 -1.305 5.23 -3.744 3.745a.724 .724 0 0 0 -1.08 .447c-.673 2.775 -4.62 2.775 -5.294 0a.724 .724 0 0 0 -1.08 -.448c-2.439 1.485 -5.23 -1.305 -3.745 -3.744a.724 .724 0 0 0 -.447 -1.08c-2.775 -.673 -2.775 -4.62 0 -5.294a.724 .724 0 0 0 .448 -1.08c-1.485 -2.439 1.305 -5.23 3.744 -3.745a.722 .722 0 0 0 1.08 -.447c.673 -2.775 4.62 -2.775 5.294 0zm-2.647 4.919a3 3 0 1 0 0 6a3 3 0 0 0 0 -6" />
      </IconBase>
    );

    const History = (props) => (
      <IconBase {...props}>
        <path d="M17 3.34a10 10 0 1 1 -14.995 8.984l-.005 -.324l.005 -.324a10 10 0 0 1 14.995 -8.336zm-5 2.66a1 1 0 0 0 -.993 .883l-.007 .117v5l.009 .131a1 1 0 0 0 .197 .477l.087 .1l3 3l.094 .082a1 1 0 0 0 1.226 0l.094 -.083l.083 -.094a1 1 0 0 0 0 -1.226l-.083 -.094l-2.707 -2.708v-4.585l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
      </IconBase>
    );

    const AlertCircle = (props) => (
      <IconBase {...props}>
        <path d="M12 2c5.523 0 10 4.477 10 10a10 10 0 0 1 -19.995 .324l-.005 -.324l.004 -.28c.148 -5.393 4.566 -9.72 9.996 -9.72zm.01 13l-.127 .007a1 1 0 0 0 0 1.986l.117 .007l.127 -.007a1 1 0 0 0 0 -1.986l-.117 -.007zm-.01 -8a1 1 0 0 0 -.993 .883l-.007 .117v4l.007 .117a1 1 0 0 0 1.986 0l.007 -.117v-4l-.007 -.117a1 1 0 0 0 -.993 -.883z" />
      </IconBase>
    );

    const X = (props) => (
      <IconBase {...props}>
        <path d="M17 3.34a10 10 0 1 1 -14.995 8.984l-.005 -.324l.005 -.324a10 10 0 0 1 14.995 -8.336zm-6.489 5.8a1 1 0 0 0 -1.218 1.567l1.292 1.293l-1.292 1.293l-.083 .094a1 1 0 0 0 1.497 1.32l1.293 -1.292l1.293 1.292l.094 .083a1 1 0 0 0 1.32 -1.497l-1.292 -1.293l1.292 -1.293l.083 -.094a1 1 0 0 0 -1.497 -1.32l-1.293 1.292l-1.293 -1.292l-.094 -.083z" />
      </IconBase>
    );

    const Filter = (props) => (
      <IconBase {...props}>
        <path d="M20 3h-16a1 1 0 0 0 -1 1v2.227l.008 .223a3 3 0 0 0 .772 1.795l4.22 4.641v8.114a1 1 0 0 0 1.316 .949l6 -2l.108 -.043a1 1 0 0 0 .576 -.906v-6.586l4.121 -4.12a3 3 0 0 0 .879 -2.123v-2.171a1 1 0 0 0 -1 -1z" />
      </IconBase>
    );

    const ChevronDown = (props) => (
      <IconBase {...props}>
        <path d="M18 9c.852 0 1.297 .986 .783 1.623l-.076 .084l-6 6a1 1 0 0 1 -1.32 .083l-.094 -.083l-6 -6l-.083 -.094l-.054 -.077l-.054 -.096l-.017 -.036l-.027 -.067l-.032 -.108l-.01 -.053l-.01 -.06l-.004 -.057v-.118l.005 -.058l.009 -.06l.01 -.052l.032 -.108l.027 -.067l.07 -.132l.065 -.09l.073 -.081l.094 -.083l.077 -.054l.096 -.054l.036 -.017l.067 -.027l.108 -.032l.053 -.01l.06 -.01l.057 -.004l12.059 -.002z" />
      </IconBase>
    );

    const FileUp = (props) => (
      <IconBase {...props}>
        <path d="M12 2l.117 .007a1 1 0 0 1 .876 .876l.007 .117v4l.005 .15a2 2 0 0 0 1.838 1.844l.157 .006h4l.117 .007a1 1 0 0 1 .876 .876l.007 .117v9a3 3 0 0 1 -2.824 2.995l-.176 .005h-10a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-14a3 3 0 0 1 2.824 -2.995l.176 -.005zm0 9l-.09 .004l-.058 .007l-.118 .025l-.105 .035l-.113 .054l-.111 .071a1 1 0 0 0 -.112 .097l-2.5 2.5a1 1 0 0 0 0 1.414l.094 .083a1 1 0 0 0 1.32 -.083l.793 -.793v3.586a1 1 0 0 0 2 0v-3.585l.793 .792a1 1 0 0 0 1.414 -1.414l-2.5 -2.5l-.082 -.073l-.104 -.074l-.098 -.052l-.11 -.044l-.112 -.03l-.126 -.017z" />
        <path d="M19 7h-4l-.001 -4.001z" />
      </IconBase>
    );

    const ImageIcon = (props) => (
      <IconBase {...props}>
        <path d="M8.813 11.612c.457 -.38 .918 -.38 1.386 .011l.108 .098l4.986 4.986l.094 .083a1 1 0 0 0 1.403 -1.403l-.083 -.094l-1.292 -1.293l.292 -.293l.106 -.095c.457 -.38 .918 -.38 1.386 .011l.108 .098l4.674 4.675a4 4 0 0 1 -3.775 3.599l-.206 .005h-12a4 4 0 0 1 -3.98 -3.603l6.687 -6.69l.106 -.095zm9.187 -9.612a4 4 0 0 1 3.995 3.8l.005 .2v9.585l-3.293 -3.292l-.15 -.137c-1.256 -1.095 -2.85 -1.097 -4.096 -.017l-.154 .14l-.307 .306l-2.293 -2.292l-.15 -.137c-1.256 -1.095 -2.85 -1.097 -4.096 -.017l-.154 .14l-5.307 5.306v-9.585a4 4 0 0 1 3.8 -3.995l.2 -.005h12zm-2.99 5l-.127 .007a1 1 0 0 0 0 1.986l.117 .007l.127 -.007a1 1 0 0 0 0 -1.986l-.117 -.007z" />
      </IconBase>
    );

    const NAV_ITEMS = [
      { id: "ambience", label: "Ambience", icon: Music },
      { id: "loot", label: "Loot Roller", icon: Dice },
      { id: "surge", label: "Arcane Surge", icon: Sparkles },
      { id: "notes", label: "Notes", icon: FileText },
      { id: "background", label: "Background", icon: ImageIcon },
      { id: "portrait", label: "Portrait", icon: ImageIcon }
    ];

    const AMBIENCE_TRACKS = [
      { label: "Sky", file: "tracks/%E2%98%81%EF%B8%8F%20Sky.mp3" },
      { label: "Rain", file: "tracks/%E2%98%94%20Rain.mp3" },
      { label: "Thunderstorm", file: "tracks/%E2%9B%88%EF%B8%8F%20Thunderstorm.mp3" },
      { label: "Beach", file: "tracks/%E2%9B%B1%EF%B8%8F%20Beach.mp3" },
      { label: "Arcane", file: "tracks/%E2%9C%A8%20Arcane.mp3" },
      { label: "Arctic", file: "tracks/%E2%9D%84%EF%B8%8F%20Arctic.mp3" },
      { label: "Hum", file: "tracks/%F0%9F%8C%80%20Hum.mp3" },
      { label: "Void", file: "tracks/%F0%9F%8C%91%20Void.mp3" },
      { label: "Heavy Rain", file: "tracks/%F0%9F%8C%A7%EF%B8%8F%20Heavy%20Rain.mp3" },
      { label: "Rain", file: "tracks/%F0%9F%8C%A7%EF%B8%8F%20Rain.mp3" },
      { label: "Thunderstorm", file: "tracks/%F0%9F%8C%A9%EF%B8%8F%20Thunderstorm.mp3" },
      { label: "Rainstorm", file: "tracks/%F0%9F%8C%AA%EF%B8%8F%20Rainstorm.mp3" },
      { label: "Big Forest", file: "tracks/%F0%9F%8C%B2%20Big%20Forest.mp3" },
      { label: "Jungle", file: "tracks/%F0%9F%8C%B4%20Jungle.mp3" },
      { label: "Desert Night", file: "tracks/%F0%9F%8C%B5%20Desert%20Night.mp3" },
      { label: "Field", file: "tracks/%F0%9F%8C%BF%20Field.mp3" },
      { label: "Tavern Calm", file: "tracks/%F0%9F%8D%B4%20Tavern%20Calm.mp3" },
      { label: "Tavern", file: "tracks/%F0%9F%8D%B4%20Tavern.mp3" },
      { label: "Snow Mountain", file: "tracks/%F0%9F%8F%94%EF%B8%8F%20Snow%20Mountain.mp3" },
      { label: "Underwater Cave", file: "tracks/%F0%9F%8F%94%EF%B8%8F%20Underwater%20Cave.mp3" },
      { label: "Hall", file: "tracks/%F0%9F%8F%9B%EF%B8%8F%20Hall.mp3" },
      { label: "Forest", file: "tracks/%F0%9F%90%A6%20Forest.mp3" },
      { label: "Carriage", file: "tracks/%F0%9F%90%B4%20Carriage.mp3" },
      { label: "Swamp", file: "tracks/%F0%9F%90%B8%20Swamp.mp3" },
      { label: "Crowd", file: "tracks/%F0%9F%91%AF%20Crowd.mp3" },
      { label: "Lake", file: "tracks/%F0%9F%92%A7%20Lake.mp3" },
      { label: "Heavy Wind", file: "tracks/%F0%9F%92%A8%20Heavy%20Wind.mp3" },
      { label: "Wind", file: "tracks/%F0%9F%92%A8%20Wind.mp3" },
      { label: "Burning", file: "tracks/%F0%9F%94%A5%20Burning.mp3" },
      { label: "Campfire", file: "tracks/%F0%9F%94%A5%20Campfire.mp3" },
      { label: "Mountain", file: "tracks/%F0%9F%97%BB%20Mountain.mp3" },
      { label: "Orgrimmar", file: "tracks/%F0%9F%9B%96%20Orgrimmar.mp3" },
      { label: "Savannah", file: "tracks/%F0%9F%A6%92%20Savannah.mp3" },
      { label: "Magic", file: "tracks/%F0%9F%AA%84%20Magic.mp3" },
      { label: "Cave", file: "tracks/%F0%9F%AA%A8%20Cave.mp3" }
    ];

    const DEFAULT_SHEET_ID = "1mjI0ROF2BPhbBX61Dykcd15viTV3Ef0tp6iIv__e_5M";
    const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwK4yHMGbdW26LwFysBrGy2Qtnt1p1NEiOn0S4ue9ZqoaloN7Nz0-xd9FtKIJqCSlsj/exec";
    const SHEET_TABS = ["Weapons", "Armor", "Potions", "Scrolls", "Treasure", "Trade goods", "Wondrous", "Trinkets"];
    const UI_CATEGORIES = ["Random", "Equipment", ...SHEET_TABS];

    const FALLBACK_ITEMS = [
      { name: "Demo Longsword", rarity: "Common", description: "A basic sword. Configure your Script URL in settings to load real items!", value: 1500, category: "Weapons" },
      { name: "Demo Potion", rarity: "Uncommon", description: "Heals 2d4+2. Configure your Script URL in settings to load real items!", value: 5000, category: "Potions" },
      { name: "Demo Shield", rarity: "Rare", description: "+1 AC. Configure your Script URL in settings to load real items!", value: 45000, category: "Armor" },
      { name: "Demo Ring", rarity: "Legendary", description: "A ring of power. Configure your Script URL in settings to load real items!", value: 500000, category: "Wondrous" }
    ];

    const RARITY_WEIGHTS = { "Common": 5500, "Uncommon": 3000, "Rare": 1000, "Very Rare": 400, "Legendary": 99, "Artifact": 1 };
    const RARITY_TEXT_COLORS = { "Common": "text-slate-400", "Uncommon": "text-emerald-400", "Rare": "text-cyan-400", "Very Rare": "text-purple-400", "Epic": "text-purple-400", "Legendary": "text-amber-400", "Artifact": "text-rose-500" };
    const RARITY_COLORS = { "Common": "border-slate-600 shadow-slate-500/10 bg-slate-500/5", "Uncommon": "border-emerald-600 shadow-emerald-500/20 bg-emerald-500/10", "Rare": "border-cyan-500 shadow-cyan-500/20 bg-cyan-500/10", "Very Rare": "border-purple-500 shadow-purple-500/20 bg-purple-500/10", "Epic": "border-purple-500 shadow-purple-500/20 bg-purple-500/10", "Legendary": "border-amber-500 shadow-amber-500/40 bg-amber-500/10", "Artifact": "border-rose-600 shadow-rose-500/50 bg-rose-500/10" };
    const RARITY_FLASH_COLORS = { "Common": "bg-slate-500/10", "Uncommon": "bg-emerald-500/20", "Rare": "bg-cyan-500/20", "Very Rare": "bg-purple-500/25", "Epic": "bg-purple-500/25", "Legendary": "bg-amber-500/30", "Artifact": "bg-rose-600/40" };
    const RARITY_BG_DOT = { "Common": "bg-slate-500", "Uncommon": "bg-emerald-500", "Rare": "bg-cyan-500", "Very Rare": "bg-purple-500", "Epic": "bg-purple-500", "Legendary": "bg-amber-500", "Artifact": "bg-rose-600" };

    const normalizeRarity = (r) => {
      if (!r) return "Common";
      const l = r.trim().toLowerCase();
      if (l === "common" || l === "none") return "Common";
      if (l === "uncommon") return "Uncommon";
      if (l === "rare") return "Rare";
      if (l === "very rare" || l === "veryrare" || l === "epic") return "Very Rare";
      if (l === "legendary") return "Legendary";
      if (l === "artifact") return "Artifact";
      return "Common";
    };

    const parseCSV = (text) => {
      const rows = []; let r = []; let c = ""; let q = false;
      for (let i = 0; i < text.length; i++) {
        const char = text[i], next = text[i + 1];
        if (char === '"') { if (q && next === '"') { c += '"'; i++; } else { q = !q; } }
        else if (char === "," && !q) { r.push(c.trim()); c = ""; }
        else if ((char === "\r" || char === "\n") && !q) {
          if (c || r.length > 0) r.push(c.trim());
          if (r.length > 0) rows.push(r);
          r = []; c = "";
          if (char === "\r" && next === "\n") i++;
        } else { c += char; }
      }
      if (c || r.length > 0) { r.push(c.trim()); rows.push(r); }
      return rows;
    };

    const formatMoney = (val) => {
      if (!val || isNaN(val)) return null;
      let cp = parseInt(val, 10);
      const pp = Math.floor(cp / 1000); cp %= 1000;
      const gp = Math.floor(cp / 100); cp %= 100;
      const sp = Math.floor(cp / 10); cp %= 10;
      const parts = [];
      if (pp > 0) parts.push({ val: pp, unit: "p", color: "text-slate-200" });
      if (gp > 0) parts.push({ val: gp, unit: "g", color: "text-yellow-400" });
      if (sp > 0) parts.push({ val: sp, unit: "s", color: "text-slate-400" });
      if (cp > 0) parts.push({ val: cp, unit: "c", color: "text-orange-600" });
      if (parts.length === 0) return { val: 0, unit: "c", color: "text-slate-600" };
      return parts;
    };

    const fetchWithRetry = async (url, retries = 3, delay = 1000, timeout = 20000) => {
      for (let i = 0; i < retries; i++) {
        try {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeout);
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(id);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.text();
        } catch (err) {
          const isTimeout = err.name === "AbortError";
          const errorMsg = isTimeout ? `Timeout (${timeout}ms)` : err.message;
          if (i === retries - 1) throw new Error(errorMsg);
          await new Promise((res) => setTimeout(res, delay * (i + 1)));
        }
      }
      return "";
    };

    const SURGE_EFFECTS = [
      "CRUSHING FORCE DAMAGES YOU EQUAL TO 1D4 X SPELL LEVEL",
      "YOU GROW DEMONIC FOR 1 MIN; ADVANTAGE ON INTIMIDATION, DISADVANTAGE ON PERSUASION",
      "A RANDOM ELEMENTAL SURGE BURSTS WITHIN 10 FEET",
      "YOU AND A CLOSEST CREATURE BLINK OUT OF EXISTENCE FOR 1D4 ROUNDS",
      "MANA WRAITH APPEARS AND ATTACKS YOU",
      "YOUR NEXT SPELL IS CAST 1 LEVEL HIGHER BUT DEALS SPELL LEVEL DAMAGE TO YOU",
      "VOID TAINT: SMALL CREATURES ARE FRIGHTENED BY YOU FOR 24 HOURS",
      "ARCANE EXPLOSION: 10 FEET, DEX SAVE OR TAKE FORCE DAMAGE = CASTER LEVEL",
      "FRIENDLY WISP GRANTS ADVANTAGE ON YOUR NEXT SAVING THROW",
      "LEY LINE BURNOUT: YOU CAN'T CAST SPELLS UNTIL LONG REST",
      "YOU AND ONE RANDOM ENEMY SWITCH PLACES INSTANTLY",
      "MAGICAL FEEDBACK: TAKE 1D6 FORCE DAMAGE PER SPELL LEVEL CAST",
      "SPEAK IN TONGUES; NO ONE UNDERSTANDS YOU FOR 1D4 HOURS",
      "A RANDOM MAGIC ITEM IN YOUR POSSESSION IS TEMPORARILY SILENCED",
      "RANDOM WEAPON NEARBY GLOWS BRIGHTLY FOR 1 MINUTE",
      "SPELL MISFIRES INTO A RANDOM SCHOOL OF MAGIC",
      "YOU SHRIEK A PIERCING TONE; ALL WITHIN 20 FT MAKE A CON SAVE OR BE DEAFENED 1 MIN",
      "TELEPORT 10 FEET IN A RANDOM DIRECTION",
      "YOU GAIN DARKVISION 60 FT FOR 1 HOUR",
      "CONJURE A MINOR ILLUSION THAT FOLLOWS YOU FOR 1 HOUR",
      "YOU BECOME SILENT; YOU CANNOT SPEAK FOR 1D4 ROUNDS",
      "FORCEDLY SPEAK THOUGHTS OUT FOR 1 HOUR",
      "TREMOR SHAKES GROUND; CREATURES WITHIN 30 FT DEX SAVE OR FALL PRONE",
      "MIRROR IMAGE APPEARS AND MIMICS YOU FOR 1 MINUTE",
      "MOUTH BURNS IN FEL FLAMES FOR 1 MINUTE; 1D4 DMG EACH ROUND",
      "RECOVER 1D8 MANA IMMEDIATELY",
      "AGE OR DE-AGE 1D10 YEARS (50/50 CHANCE)",
      "NEXT ATTACK OR SPELL ATTACK AUTOMATICALLY MISSES",
      "YOU BECOME EXTREMELY HUNGRY; MUST EAT WITHIN 1 HOUR OR TAKE EXHAUSTION",
      "GLIMPSE TWISTING NETHER; STUNNED FOR 1 ROUND",
      "SHADOW DETACHES AND DANCES FOR 1 MINUTE",
      "PULLED 30 FEET IN A RANDOM DIRECTION",
      "ALLERGIC TO MAGIC: DISADVANTAGE ON SPELL SAVES FOR 1D4 ROUNDS",
      "MINOR LEY LINE AWAKENS: ALL CASTERS REGAIN 1D8 MANA",
      "EXPLODE WITH LIGHT; HEAL ALL WITHIN 30 FEET FOR 10 HP",
      "YOUR SPOKEN WORD BECOMES GHOSTLY AND UNINTELLIGIBLE FOR 1 HOUR",
      "YOU VOMIT VIOLENTLY, BECOMING PRONE AND INCAPACITATED FOR 1 ROUND",
      "ARCANE MISSILES LAUNCH AT EVERY CREATURE WITHIN 30 FEET (1D8 DAMAGE EACH)",
      "YOU BECOME MAGICALLY BLINDED FOR 1D4 ROUNDS",
      "YOUR HANDS GROW MASSIVE AND FOR 1 MIN (DISADVANTAGE WITH HAND PRECISION)",
      "YOU SHRINK TO 1/4 SIZE FOR 1D6 MINUTES",
      "ITEM IN HAND EXPLODES IN A PUFF OF PURPLE SMOKE (NO DAMAGE, JUST GONE)",
      "YOU BEGIN FLOATING UPSIDE DOWN 3 FEET ABOVE THE GROUND FOR 1 MINUTE",
      "YOUR NEXT SPELL IS REVERSED IN EFFECT (GM DETERMINES OUTCOME)",
      "A SMALL PORTAL OPENS AND A RANDOM PIECE OF FURNITURE FALLS ON YOU (1D6 DAMAGE)",
      "YOU BECOME A RANDOM ANIMAL FOR 1D4 MINUTES",
      "ALL TEXT AND SYMBOLS AROUND YOU REARRANGE INTO NONSENSE FOR 10 MINUTES",
      "A MYSTERIOUS ARCANE HAND SLAPS YOU (1D4 DAMAGE, NO SAVE)",
      "YOU RANDOMLY SWAP BODIES WITH AN ALLY FOR 1D4 ROUNDS (MENTAL STATS STAY, PHYSICAL CHANGE)",
      "A RANDOM WILD BEAST (CR 4) IS SUMMONED NEAR YOU AND STARTLES EVERYONE",
      "YOU BECOME ETHEREAL FOR 1 ROUND, UNABLE TO TOUCH OR BE TOUCHED",
      "YOU CHANT THE NAME OF YOUR DEITY LOUDLY AND INCOHERENTLY FOR 1D4 ROUNDS",
      "YOUR ARMOR OR CLOTHES SEPARATE AND BEGIN DANCING FOR 1 MINUTE",
      "YOUR BODY CHANGES GENDER FOR 24 HOURS",
      "EVERYTHING YOU TOUCH FEELS EXTREMELY SLIPPERY FOR 10 MINUTES",
      "TRAPPED IN A MAGICAL BUBBLE; FLOAT 10 FEET UP FOR 1 MINUTE",
      "A SPECTER OF YOUR FAMILY MEMBER APPEARS AND REACTS TO YOUR NEXT ACTION",
      "YOUR FEET LIGHT ON FIRE, CAUSING YOU TO RUN RANDOMLY FOR 1 ROUND (NO DAMAGE)",
      "SPELL WILDLY SUCCESSFUL: DOUBLE RANGE, DURATION, OR POWER (YOUR CHOICE)",
      "YOU DISINTEGRATE INTO PURE ARCANE ENERGY UNTIL SOMEONE CASTS A SPELL"
    ];

    const CRITICAL_EFFECTS = [
      "ALL CREATURES WITHIN 120 FEET ARE TELEPORTED RANDOMLY UP TO 1 MILE AWAY",
      "TIME WARPS: EVERY CREATURE IN 30 FEET TAKES 1 EXTRA TURN IMMEDIATELY",
      "A BLACK HOLE FORMS, GROWING 10 FEET EACH TURN FOR 1 HOUR",
      "ALL MAGICAL EFFECTS IN 1000 FEET ARE IMMEDIATELY DISPELLED",
      "YOUR MIND BRIEFLY TOUCHES THE VOID: YOU GAIN A MADNESS EFFECT",
      "YOU GAIN A SINGLE USE OF WISH, FOR A PRICE",
      "YOU FLOOD WITH RAW MAGIC: ARCANE SURGE EVERY ROUND FOR 1D6 ROUNDS",
      "A COLLAPSE IN REALITY ERASES 30 FT OF TERRAIN INTO NOTHINGNESS",
      "YOU ARE GRANTED POWERS OF A DEMIGOD FOR 1 MINUTE (ALL ABILITY SCORES SET TO 24)",
      "TIME FREEZES FOR ALL CREATURES EXCEPT YOU FOR 1 ROUND",
      "A RANDOM ALLY WITHIN 60 FEET IS TURNED TO STONE FOR 1D6 ROUNDS (NO SAVE)",
      "YOU BECOME A LIVING ARCANE STORM; 3D10 LIGHTNING DAMAGE TO ALL CREATURES WITHIN 30 FEET EACH ROUND FOR 1 MIN",
      "YOU ARE FULLY HEALED AND REGAIN ALL MANA - IMMEDIATELY SUFFER 1D4 LEVEL OF EXHAUSTION",
      "PLANES COLLIDE: 10D10 PLANAR RIFTS APPEAR",
      "THE NEXT SPELL YOU CAST INSTANTLY MAXIMIZES DAMAGE, RANGE, AND DURATION - BUT YOU TAKE HALF THE DAMAGE YOURSELF",
      "A MASSIVE EARTHQUAKE ERUPTS CENTERED ON YOU (DMG EARTHQUAKE SPELL EFFECTS)",
      "YOU LOSE ALL SENSE OF SELF: CONTROL OF YOUR CHARACTER PASSES TO THE GM FOR 1D4 ROUNDS",
      "TWISTING NETHER APPEARS IN THE SKY FOR 1D6 HOURS, CAUSING MASSIVE ENVIRONMENTAL CHAOS",
      "THE BARRIER BETWEEN LIFE AND DEATH WEAKENS: 1D100 DEAD CREATURES WITHIN 1 KM RISE AS UNDEAD FOR 24 HOURS"
    ];

    const BACKGROUND_ARTSTYLE_PRIMER = "Blizzard and Hearthstone-inspired cinematic digital illustration, 8k concept art. Instead of realistic grit, surfaces have painterly brushstrokes and soft gradients. Hand-painted textures, vibrant saturated colors, chunky whimsical design, soft cinematic lighting, rim lighting, clean bold shapes, high-quality game art style. Voluminous fluffy smudgy clouds if clouds are seen. Spatious and wide establishing shot, painterly finish, hand-painted materials and textures, storytelling props. No text, no outlines, no linework, no lineart, no humans, no people, no logos, no watermarks, no UI elements.";
    const REF_STYLE_ARTSTYLE_PRIMER = "Spatious and wide establishing shot. No text, no outlines, no linework, no lineart, no humans, no people, no logos, no watermarks, no UI elements.";
    const BACKGROUND_DEFAULT_API_KEY = "AIzaSyB7uRsnfyHu9uH4rvGEj0Kf9I5RPBBNJHw";
    const BACKGROUND_STYLES = [
      { id: "murokellari", label: "Murokellari", primer: "Elven ruined stone manor in the Twisting Nether. The environment is built from chunky, heavily stylized stone blocks, featuring sharp, exaggerated edges and deep crevices to emphasize age and decay. The architecture combines grand elven arches and columns with a sense of broken, overgrown moss that clings to stone. The color palette is dominated by muted, cool grays for the stone, sharply contrasted with vibrant, ethereal purple and magenta slight ambient light." },
      {
        id: "troll-city",
        label: "Troll City",
        primer: "Aztec environment with WoW's troll tribal jungle culture. No face murals or carvings. No magic. No tiki masks. Motifs are inspired by jungle flora and ONE jungle fauna. The color palette features warm earthy tones of sandstone, deep greens of jungle foliage, and vibrant accents of turquoise and gold in ceremonial areas. The overall atmosphere has focus on natural materials and bold." ,
        contexts: [
          { id: "within city", label: "Within City", primer: "Ancient chunky and weathered sandstone for architectural elements. Stone, rope and primitive construction when applicable. Large areas with scarce detail." },
          { id: "indoors", label: "Indoors", primer: "Weathered sandstone for walls and ceilings, rough thick worn wood planks OR sandstone for floor. Stone, rope and primitive construction when applicable. Props vary from simple woven baskets to tribal vases and rugs and beads, etc." },
          { id: "outskirts", label: "Outskirts", primer: "Warm lush jungle, no buildings or architecture." }
        ]
      },
      { id: "frozen-tundra", label: "Frozen Tundra", primer: "Blinding snowfields, jagged ice, aurora glow, biting wind, lonely silhouettes." },
      { id: "primal-jungle", label: "Primal Jungle", primer: "Stranglethorn-inspired primal jungle, dense canopy, colossal roots, humid haze, sunbeams through leaves." },
      { id: "moonglade", label: "Moonglade", primer: "Moonlit glades, ancient druidic stones, soft blue-green glow, tranquil pools, ethereal fireflies." },
      { id: "emerald-dream", label: "Emerald Dream", primer: "Lush otherworldly untouched forest, glowing flora, dreamlike mist, timeless serenity. No equipment or tools. No clouds, no rocks, no stones. Rarely has one element (thick rope around a tree or hanging beads or woven dreamcatcher)" },
      { id: "barrens", label: "Barrens", primer: "Arid savannah, red earth and tall grasses, dusty wind, vast skies, rugged mesas, sun-baked atmosphere." },
      { id: "image", label: "Image only", primer: "" }
    ];
    const BACKGROUND_STORAGE_KEYS = {
      styleId: "dm_background_style_id",
      prompt: "dm_background_prompt",
      context: "dm_background_context",
      styleOverrides: "dm_background_style_overrides"
    };

    const PORTRAIT_STYLES = [
      { id: "drawn", label: "Drawn", primer: "Hand-drawn digital sketch, graphic novel illustration, expressive comic book art style, high-contrast ink-wash aesthetic, very exaggerated shapes. Cowboy shot of the character in flat white background. Line Art: Bold and messy ink linework, variable-width outlines, rough sketchy edges, visible construction lines, hand-drawn energy, scratchy textures. Shading & Texture: Heavy cel-shading, hatching and cross-hatching for texture, gritty surface details, smooth gradients. Lighting & Color: Soft color blocks with clear accents, sharp white rim lighting, high-contrast highlights, subsurface scattering glow in thin areas (like ears), dramatic directional light." },
      { id: "stylized", label: "Stylized", primer: "Hearthstone card illustration style, Blizzard-esque game art, painterly fantasy art, high-quality digital illustration. Cowboy shot of the character in flat white background. Rendering & Line Art: Lineless art style, edges defined by light and shadow, soft-edge rendering, smooth color transitions, chunky shapes, stylized proportions, expressive facial features. Lighting: Soft volumetric lighting, rim lighting, subsurface scattering on skin. Texture & Color: Vibrant saturated color palette, matte textures for cloth and leather, silky hair clumps, subtle painterly brushstrokes, clean polished finish, high-contrast lighting." }
    ];
    const PORTRAIT_RACES = [
      { id: "troll-darkspear", label: "Troll, Darkspear", primer: "Warcraft Darkspear troll features: tall, lanky, long limbs, big tusks, purple skin tone, long pointy ears, hunched posture, tribal adornments. Max 2 fingers and thumb per hand. Not a goblin." },
      { id: "troll-jungle", label: "Troll, Jungle", primer: "Warcraft Jungle troll features: tall, lanky, long limbs, big tusks, blue skin tone, long pointy ears, hunched posture, tribal adornments. Max 2 fingers and thumb per hand. Not a goblin." },
      { id: "orc", label: "Orc", primer: "Warcraft orc features: muscular build, tusks, short pointy ears, strong jaw, rugged armor, warlike presence." },
      { id: "night-elf", label: "Night Elf", primer: "Night Elf features: tall, lithe, long pointy ears, glowing eyes." }
    ];
    const PORTRAIT_STORAGE_KEYS = {
      styleId: "dm_portrait_style_id",
      raceId: "dm_portrait_race_id",
      prompt: "dm_portrait_prompt"
    };

    const App = () => {
      const [activeView, setActiveView] = useState(() => localStorage.getItem("dm_dashboard_view") || "ambience");
      const activeMeta = NAV_ITEMS.find((item) => item.id === activeView) || NAV_ITEMS[0];

      useEffect(() => {
        localStorage.setItem("dm_dashboard_view", activeView);
      }, [activeView]);

      return (
        <div className="min-h-screen flex ambient-bg">
          <aside className="w-64 bg-[#0d0d14]/90 border-r border-white/5 p-6 flex flex-col gap-8">
            <div>
              <div className="text-xs uppercase tracking-[0.4em] text-white/40">DM</div>
              <div className="title-font text-lg text-white tracking-[0.25em]">Dashboard</div>
            </div>

            <nav className="flex flex-col gap-2">
              {NAV_ITEMS.map((item) => {
                const Icon = item.icon;
                const isActive = item.id === activeView;
                return (
                  <button
                    key={item.id}
                    onClick={() => setActiveView(item.id)}
                    className={`flex items-center gap-3 px-4 py-3 rounded-xl border transition-all text-sm ${
                      isActive
                        ? "bg-white text-black border-white shadow-lg shadow-white/10"
                        : "bg-white/5 text-white/70 border-transparent hover:bg-white/10 hover:text-white"
                    }`}
                  >
                    <Icon className="w-4 h-4" />
                    <span className="uppercase tracking-widest">{item.label}</span>
                  </button>
                );
              })}
            </nav>

            <HpTracker />
          </aside>

          <main className="flex-1 h-screen overflow-y-auto">
            <div className="p-6 lg:p-10">
              <header className="flex flex-col gap-2 mb-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-xl bg-white/5 border border-white/10">
                    <activeMeta.icon className="w-5 h-5 text-white/80" />
                  </div>
                  <div>
                    <div className="title-font text-2xl tracking-[0.2em]">{activeMeta.label}</div>
                  </div>
                </div>
              </header>

              <div className={activeView === "ambience" ? "block" : "hidden"}>
                <AmbiencePanel />
              </div>
              <div className={activeView === "loot" ? "block" : "hidden"}>
                <LootRollerPanel />
              </div>
              <div className={activeView === "surge" ? "block" : "hidden"}>
                <ArcaneSurgePanel />
              </div>
              <div className={activeView === "notes" ? "block" : "hidden"}>
                <NotesPanel />
              </div>
              <div className={activeView === "background" ? "block" : "hidden"}>
                <BackgroundPanel />
              </div>
              <div className={activeView === "portrait" ? "block" : "hidden"}>
                <PortraitPanel />
              </div>
            </div>
          </main>
        </div>
      );
    };

    const AmbiencePanel = () => {
      const audioContextRef = useRef(null);
      const masterGainRef = useRef(null);
      const activeTracksRef = useRef({});
      const sleepTimeoutRef = useRef(null);
      const countdownIntervalRef = useRef(null);

      const [masterVolume, setMasterVolume] = useState(0.7);
      const [activeUrls, setActiveUrls] = useState([]);
      const [pendingUrl, setPendingUrl] = useState(null);
      const [timerActive, setTimerActive] = useState(false);
      const [timeRemaining, setTimeRemaining] = useState(30 * 60);

      useEffect(() => {
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
        masterGainRef.current = audioContextRef.current.createGain();
        masterGainRef.current.gain.setValueAtTime(masterVolume, audioContextRef.current.currentTime);
        masterGainRef.current.connect(audioContextRef.current.destination);

        return () => {
          clearTimeout(sleepTimeoutRef.current);
          clearInterval(countdownIntervalRef.current);
          Object.values(activeTracksRef.current).forEach((track) => {
            track.audio.pause();
            try { track.source.disconnect(); } catch (err) {}
          });
          activeTracksRef.current = {};
        };
      }, []);

      useEffect(() => {
        if (audioContextRef.current && masterGainRef.current) {
          masterGainRef.current.gain.setValueAtTime(masterVolume, audioContextRef.current.currentTime);
        }
      }, [masterVolume]);

      const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remaining = seconds % 60;
        return `${minutes}:${String(remaining).padStart(2, "0")}`;
      };

      const startTimer = () => {
        if (sleepTimeoutRef.current) return;
        setTimerActive(true);
        sleepTimeoutRef.current = setTimeout(() => fadeOutAllTracks(), timeRemaining * 1000);
        countdownIntervalRef.current = setInterval(() => {
          setTimeRemaining((prev) => {
            if (prev <= 1) {
              stopTimer();
              return 30 * 60;
            }
            return prev - 1;
          });
        }, 1000);
      };

      const stopTimer = () => {
        clearTimeout(sleepTimeoutRef.current);
        clearInterval(countdownIntervalRef.current);
        sleepTimeoutRef.current = null;
        countdownIntervalRef.current = null;
        setTimerActive(false);
        setTimeRemaining(30 * 60);
      };

      const toggleTimer = () => {
        if (timerActive) stopTimer();
        else startTimer();
      };

      const fadeOutAllTracks = () => {
        const fadeDuration = 60;
        Object.keys(activeTracksRef.current).forEach((url) => {
          const track = activeTracksRef.current[url];
          const now = audioContextRef.current.currentTime;
          track.gainNode.gain.cancelScheduledValues(now);
          track.gainNode.gain.setValueAtTime(track.gainNode.gain.value, now);
          track.gainNode.gain.linearRampToValueAtTime(0, now + fadeDuration);
          setTimeout(() => {
            track.audio.pause();
            track.source.disconnect();
            delete activeTracksRef.current[url];
            setActiveUrls(Object.keys(activeTracksRef.current));
          }, fadeDuration * 1000);
        });
      };

      const playTrack = async (track) => {
        if (!audioContextRef.current) return;
        if (audioContextRef.current.state === "suspended") await audioContextRef.current.resume();

        setPendingUrl(track.file);
        const audio = new Audio(track.file);
        audio.crossOrigin = "anonymous";
        audio.loop = true;

        const source = audioContextRef.current.createMediaElementSource(audio);
        const gainNode = audioContextRef.current.createGain();
        gainNode.gain.setValueAtTime(0, audioContextRef.current.currentTime);

        source.connect(gainNode);
        gainNode.connect(masterGainRef.current);

        try {
          await audio.play();
          const fadeDuration = 4.5;
          gainNode.gain.linearRampToValueAtTime(1, audioContextRef.current.currentTime + fadeDuration);
          activeTracksRef.current[track.file] = { audio, source, gainNode, label: track.label };
          setActiveUrls(Object.keys(activeTracksRef.current));
          setTimeout(() => setPendingUrl(null), fadeDuration * 1000);
        } catch (err) {
          setPendingUrl(null);
        }
      };

      const stopTrack = (track) => {
        const active = activeTracksRef.current[track.file];
        if (!active) return;
        setPendingUrl(track.file);
        const fadeDuration = 4.5;
        const now = audioContextRef.current.currentTime;
        active.gainNode.gain.cancelScheduledValues(now);
        active.gainNode.gain.setValueAtTime(active.gainNode.gain.value, now);
        active.gainNode.gain.linearRampToValueAtTime(0, now + fadeDuration);
        setTimeout(() => {
          active.audio.pause();
          active.source.disconnect();
          delete activeTracksRef.current[track.file];
          setActiveUrls(Object.keys(activeTracksRef.current));
          setPendingUrl(null);
        }, fadeDuration * 1000);
      };

      const stopAll = () => {
        Object.keys(activeTracksRef.current).forEach((url) => {
          stopTrack({ file: url });
        });
      };

      return (
        <div className="grid grid-cols-1 xl:grid-cols-[1.2fr_0.8fr] gap-6">
          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col min-h-[70vh] max-h-[80vh]">
            <div className="flex flex-col gap-4 mb-6">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-xs uppercase tracking-[0.3em] text-white/40">Soundboard</div>
                  <div className="text-lg font-semibold text-white/90">Layered ambience</div>
                </div>
                <button
                  onClick={stopAll}
                  className="px-4 py-2 rounded-full border border-white/10 text-xs uppercase tracking-[0.2em] text-white/60 hover:text-white hover:border-white/30 transition"
                >
                  Stop All
                </button>
              </div>

              <div className="flex flex-col gap-3 bg-black/30 border border-white/5 rounded-2xl p-4">
                <div className="flex items-center justify-between">
                  <span className="text-xs uppercase tracking-[0.2em] text-white/40">Master Volume</span>
                  <span className="text-sm text-white/70">{Math.round(masterVolume * 100)}%</span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={Math.round(masterVolume * 100)}
                  onChange={(e) => setMasterVolume(Number(e.target.value) / 100)}
                  className="w-full accent-pink-500"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 overflow-y-auto custom-scrollbar pr-1" style={{ maxHeight: "calc(80vh - 220px)" }}>
              {AMBIENCE_TRACKS.map((track) => {
                const isActive = activeUrls.includes(track.file);
                const isPending = pendingUrl === track.file;
                return (
                  <button
                    key={track.file}
                    onClick={() => (isActive ? stopTrack(track) : playTrack(track))}
                    disabled={isPending}
                    className={`group relative overflow-hidden rounded-2xl border px-4 py-4 text-left transition-all ${
                      isActive
                        ? "bg-gradient-to-br from-pink-600/80 via-purple-600/80 to-indigo-600/80 text-white border-transparent shadow-lg shadow-pink-500/20"
                        : "bg-white/5 border-white/10 text-white/80 hover:bg-white/10"
                    } ${isPending ? "opacity-70 cursor-wait" : ""}`}
                  >
                    <div className="text-lg font-semibold tracking-wide">{track.label}</div>
                  </button>
                );
              })}
            </div>
          </div>

          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs uppercase tracking-[0.3em] text-white/40">Sleep Timer</div>
                <div className="text-xl font-semibold">{formatTime(timeRemaining)}</div>
              </div>
              <button
                onClick={toggleTimer}
                className={`px-4 py-2 rounded-full text-xs uppercase tracking-[0.3em] border transition ${
                  timerActive
                    ? "bg-pink-500 text-white border-pink-400"
                    : "border-white/10 text-white/60 hover:text-white hover:border-white/30"
                }`}
              >
                {timerActive ? "Active" : "Start"}
              </button>
            </div>

            <div className="bg-black/30 border border-white/5 rounded-2xl p-4">
              <div className="text-xs uppercase tracking-[0.2em] text-white/40 mb-2">Active Layers</div>
              {activeUrls.length === 0 ? (
                <div className="text-sm text-white/40">No ambience playing.</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {activeUrls.map((url) => {
                    const track = AMBIENCE_TRACKS.find((item) => item.file === url);
                    return (
                      <span key={url} className="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs uppercase tracking-[0.2em]">
                        {track ? track.label : "Track"}
                      </span>
                    );
                  })}
                </div>
              )}
            </div>

            <div className="bg-black/30 border border-white/5 rounded-2xl p-4 text-xs text-white/40 leading-relaxed">
              Tip: add or change tracks by editing the <span className="text-white/70">AMBIENCE_TRACKS</span> list in this file.
            </div>
          </div>
        </div>
      );
    };

    const LootRollerPanel = () => {
      const [sheetId, setSheetId] = useState(() => localStorage.getItem("loot_roller_sheet_id") || DEFAULT_SHEET_ID);
      const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem("loot_roller_script_url") || DEFAULT_SCRIPT_URL);
      const [instantRoll, setInstantRoll] = useState(() => localStorage.getItem("loot_roller_instant_roll") === "true");
      const [showSettings, setShowSettings] = useState(false);
      const [activeTab, setActiveTab] = useState("Random");
      const [activeRarity, setActiveRarity] = useState("Any");
      const [rollAmount, setRollAmount] = useState(1);
      const [history, setHistory] = useState([]);
      const [expandedId, setExpandedId] = useState(null);
      const [isRolling, setIsRolling] = useState(false);
      const [rollingItem, setRollingItem] = useState(null);
      const [bgFlash, setBgFlash] = useState(null);
      const [allItems, setAllItems] = useState([]);
      const [isLoaded, setIsLoaded] = useState(false);
      const [loadProgress, setLoadProgress] = useState(0);
      const [error, setError] = useState(null);
      const [failedTabs, setFailedTabs] = useState([]);
      const [loadingStatusText, setLoadingStatusText] = useState("");

      const stopRollingRef = useRef(false);
      const currentIntervalRef = useRef(null);
      const fileInputRef = useRef(null);

      useEffect(() => { loadData(false); }, [scriptUrl, sheetId]);

      const normalizeItem = (rawItem, category) => ({
        name: rawItem.name || rawItem.Name || "Unknown",
        rarity: normalizeRarity(rawItem.rarity || rawItem.Rarity),
        description: rawItem.description || rawItem.Description || rawItem.desc || "",
        value: parseInt((rawItem.value || rawItem.Value || "0").toString().replace(/\D/g, "")) || 0,
        category,
        id: Math.random().toString(36).substr(2, 9)
      });

      const loadData = async (forceRefresh = false) => {
        setIsLoaded(false); setLoadProgress(0); setError(null); setFailedTabs([]);
        const cacheKey = `loot_data_${scriptUrl || sheetId || "demo"}`;

        if (!forceRefresh) {
          const cachedData = localStorage.getItem(cacheKey);
          if (cachedData) {
            try {
              const parsed = JSON.parse(cachedData);
              if (parsed && parsed.length > 0) {
                setAllItems(parsed);
                setIsLoaded(true);
                setLoadProgress(100);
                return;
              }
            } catch (err) {}
          }
        }

        if (scriptUrl) {
          try {
            setLoadingStatusText("Connecting to Script...");
            setLoadProgress(10);
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(scriptUrl)}`;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 25000);
            const response = await fetch(proxyUrl, { signal: controller.signal });
            clearTimeout(id);
            if (response.ok) {
              setLoadProgress(50);
              setLoadingStatusText("Processing Data...");
              const data = await response.json();
              processAndFinish(data, cacheKey);
              return;
            }
          } catch (err) {
            try {
              const response = await fetch(scriptUrl);
              if (response.ok) {
                const data = await response.json();
                processAndFinish(data, cacheKey);
                return;
              }
            } catch (directErr) {}
          }
        }

        if (sheetId) {
          setLoadingStatusText("Loading Sheets...");
          let collectedItems = [];
          const failed = [];
          for (let i = 0; i < SHEET_TABS.length; i++) {
            const tabName = SHEET_TABS[i];
            setLoadingStatusText(`Loading ${tabName}...`);
            const targetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}&t=${Date.now()}`;
            const url = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
            try {
              const text = await fetchWithRetry(url, 3, 1000, 20000);
              const rows = parseCSV(text);
              if (rows.length > 1) {
                const headers = rows[0].map((h) => h.toLowerCase().trim());
                const nameIdx = headers.findIndex((h) => h.includes("name"));
                const rarityIdx = headers.findIndex((h) => h.includes("rarity"));
                const descIdx = headers.findIndex((h) => h.includes("desc") || h.includes("entry"));
                const valIdx = headers.findIndex((h) => h === "value" || h === "cost" || h === "price");

                if (nameIdx !== -1) {
                  const tabItems = rows.slice(1).map((row) => ({
                    name: row[nameIdx] || "Unknown",
                    rarity: rarityIdx !== -1 ? normalizeRarity(row[rarityIdx]) : "Common",
                    description: descIdx !== -1 ? row[descIdx] : "",
                    value: valIdx !== -1 ? parseInt(row[valIdx].replace(/\D/g, "")) || 0 : 0,
                    category: tabName,
                    id: Math.random().toString(36).substr(2, 9)
                  })).filter((i) => i.name && i.name !== "Unknown");

                  collectedItems = [...collectedItems, ...tabItems];
                  setAllItems((prev) => [...prev, ...tabItems]);
                } else { failed.push({ tab: tabName, reason: "No Name Column" }); }
              }
            } catch (err) {
              failed.push({ tab: tabName, reason: err.message || "Error" });
            } finally {
              setLoadProgress(Math.round(((i + 1) / SHEET_TABS.length) * 100));
              await new Promise((r) => setTimeout(r, 100));
            }
          }

          if (collectedItems.length > 0) {
            finishLoad(collectedItems, failed, cacheKey);
            if (failed.length > 0) setError(`Partial Load. ${failed.length} tabs failed.`);
            return;
          }
        }

        setError("Could not load from Sheets. Using Demo Data.");
        finishLoad(FALLBACK_ITEMS, [], cacheKey);
      };

      const processAndFinish = (data, cacheKey) => {
        const processed = [];
        const content = data.contents ? JSON.parse(data.contents) : data;
        Object.keys(content).forEach((cat) => {
          if (Array.isArray(content[cat])) {
            content[cat].forEach((item) => processed.push(normalizeItem(item, cat)));
          }
        });
        finishLoad(processed, [], cacheKey);
      };

      const finishLoad = (items, failed = [], cacheKey) => {
        setAllItems(items);
        setFailedTabs(failed);
        setIsLoaded(true);
        setLoadProgress(100);
        localStorage.setItem(cacheKey, JSON.stringify(items));
      };

      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            if (file.name.toLowerCase().endsWith(".csv")) {
              const rows = parseCSV(text);
              if (rows.length < 2) throw new Error("CSV has no data");
              const headers = rows[0].map((h) => h.toLowerCase().trim());
              const nameIdx = headers.findIndex((h) => h.includes("name"));
              const rarityIdx = headers.findIndex((h) => h.includes("rarity"));
              const descIdx = headers.findIndex((h) => h.includes("desc") || h.includes("entry"));
              const valIdx = headers.findIndex((h) => h === "value" || h === "cost" || h === "price");
              const processed = rows.slice(1).map((row) => ({
                name: row[nameIdx] || "Unknown",
                rarity: rarityIdx !== -1 ? normalizeRarity(row[rarityIdx]) : "Common",
                description: descIdx !== -1 ? row[descIdx] : "",
                value: valIdx !== -1 ? parseInt(row[valIdx].replace(/\D/g, "")) || 0 : 0,
                category: "Custom",
                id: Math.random().toString(36).substr(2, 9)
              })).filter((i) => i.name && i.name !== "Unknown");
              finishLoad(processed, [], "loot_data_custom");
              alert(`Loaded ${processed.length} items from CSV!`);
              setShowSettings(false);
              return;
            }
            const data = JSON.parse(text);
            const processed = [];
            if (Array.isArray(data)) {
              data.forEach((item) => processed.push(normalizeItem(item, "Custom")));
            } else {
              Object.keys(data).forEach((cat) => {
                if (Array.isArray(data[cat])) data[cat].forEach((item) => processed.push(normalizeItem(item, cat)));
              });
            }
            finishLoad(processed, [], "loot_data_custom");
            alert(`Loaded ${processed.length} items from file!`);
            setShowSettings(false);
          } catch (err) {
            alert("Failed to parse file. Ensure it's JSON or CSV.");
          }
        };
        reader.readAsText(file);
      };

      const saveSettings = (nextScriptUrl, nextInstantRoll) => {
        localStorage.setItem("loot_roller_script_url", nextScriptUrl);
        localStorage.setItem("loot_roller_sheet_id", sheetId);
        localStorage.setItem("loot_roller_instant_roll", String(nextInstantRoll));
        setShowSettings(false);
        loadData(true);
      };

      const getPool = () => {
        let pool = allItems;
        if (activeTab !== "Random") {
          if (activeTab === "Equipment") {
            pool = allItems.filter((item) => item.category === "Weapons" || item.category === "Armor");
          } else {
            pool = allItems.filter((item) => item.category === activeTab);
          }
        }
        if (activeRarity !== "Any") {
          const selected = normalizeRarity(activeRarity);
          pool = pool.filter((item) => normalizeRarity(item.rarity) === selected);
        }
        return pool;
      };

      const pickItemFromPool = (pool) => {
        const groups = { "Artifact": [], "Legendary": [], "Very Rare": [], "Rare": [], "Uncommon": [], "Common": [] };
        pool.forEach((item) => groups[normalizeRarity(item.rarity)].push(item));
        const totalWeight = Object.keys(groups).reduce((sum, key) => sum + (groups[key].length * (RARITY_WEIGHTS[key] || 0)), 0);
        if (totalWeight <= 0) return pool[0];
        let roll = Math.random() * totalWeight;
        for (const key of Object.keys(groups)) {
          roll -= (groups[key].length * (RARITY_WEIGHTS[key] || 0));
          if (roll <= 0 && groups[key].length > 0) {
            return groups[key][Math.floor(Math.random() * groups[key].length)];
          }
        }
        return pool[Math.floor(Math.random() * pool.length)];
      };

      const handleAmountChange = (delta) => {
        setRollAmount((prev) => Math.max(1, Math.min(10, prev + delta)));
      };

      const handleToggleExpand = (id) => {
        setExpandedId((prev) => (prev === id ? null : id));
      };

      const triggerRoll = async () => {
        if (isRolling) { stopRollingRef.current = true; return; }
        const pool = getPool();
        if (pool.length === 0) return;
        setIsRolling(true); stopRollingRef.current = false; setExpandedId(null);
        for (let i = 0; i < rollAmount; i++) {
          if (stopRollingRef.current) break;
          await performSingleRoll(i === rollAmount - 1, pool);
        }
        setIsRolling(false); setRollingItem(null);
      };

      const performSingleRoll = (isLast, pool) => new Promise((resolve) => {
        const finalItem = pickItemFromPool(pool);
        const finalize = () => {
          if (stopRollingRef.current) { resolve(); return; }
          setRollingItem(null);
          setBgFlash(RARITY_FLASH_COLORS[normalizeRarity(finalItem.rarity)]);
          setTimeout(() => setBgFlash(null), 800);
          const item = { ...finalItem, uniqueId: Date.now() + Math.random(), timestamp: new Date().toLocaleTimeString(), isNew: true };
          setHistory((p) => [item, ...p]); setExpandedId(item.uniqueId);
          setTimeout(() => setHistory((p) => p.map((i) => i.uniqueId === item.uniqueId ? { ...i, isNew: false } : i)), 500);
          setTimeout(resolve, 300);
        };
        if (instantRoll) { finalize(); return; }

        let tick = 0;
        const totalTicks = 50;
        const runLoop = () => {
          if (stopRollingRef.current) { clearTimeout(currentIntervalRef.current); resolve(); return; }
          if (tick >= totalTicks - 2) {
            setRollingItem({ ...finalItem, temp: true, isFinalTick: true });
          } else {
            const randomVisual = pool[Math.floor(Math.random() * pool.length)];
            setRollingItem({ ...randomVisual, temp: true, isFinalTick: false });
          }
          tick++;
          if (tick >= totalTicks) {
            setTimeout(finalize, 800);
          } else {
            const progress = tick / totalTicks;
            const delay = Math.max(30, 20 + (600 * Math.pow(progress, 4)));
            currentIntervalRef.current = setTimeout(runLoop, delay);
          }
        };
        runLoop();
      });

      const SettingsModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in-up">
          <div className="bg-[#1a1a20] border border-white/10 rounded-2xl w-full max-w-md p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onClick={() => setShowSettings(false)} className="absolute top-4 right-4 text-white/40 hover:text-white"><X className="w-4 h-4" /></button>
            <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><Settings className="w-5 h-5 text-pink-400" /> Settings</h2>
            <div className="space-y-6">
              <div>
                <label className="block text-xs font-bold uppercase tracking-wider text-white/50 mb-2">Google Apps Script URL (Fast)</label>
                <input type="text" value={scriptUrl} onChange={(e) => setScriptUrl(e.target.value)} placeholder="https://script.google.com/macros/s/..."
                  className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-3 text-sm text-white focus:border-pink-500 outline-none transition-colors" />
                <p className="text-[10px] text-white/20 mt-1">Recommended for fast loading.</p>
              </div>

              <div className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                <div className="flex flex-col">
                  <span className="text-sm font-bold text-white/90">Instant Roll</span>
                  <span className="text-[10px] text-white/40">Skip animation</span>
                </div>
                <button onClick={() => setInstantRoll(!instantRoll)} className={`w-12 h-6 rounded-full relative transition-colors duration-300 ${instantRoll ? "bg-pink-600" : "bg-white/10"}`}>
                  <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all duration-300 ${instantRoll ? "left-7" : "left-1"}`}></div>
                </button>
              </div>

              <button onClick={() => saveSettings(scriptUrl, instantRoll)} className="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-900/20 transition-all active:scale-95">Save Changes</button>

              <div className="pt-4 border-t border-white/5 mt-4">
                <label className="block text-xs font-bold uppercase tracking-wider text-white/50 mb-2">Manual Import</label>
                <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-white py-2 rounded-lg border border-white/10 transition-colors text-sm">
                  <FileUp className="w-4 h-4" /> Load JSON or CSV File
                </button>
                <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".json,.csv" />
              </div>
            </div>
          </div>
        </div>
      );

      return (
        <div className="relative bg-[#0a0a0f] text-white rounded-3xl border border-white/5 p-6 panel-glow overflow-visible">
          <div className={`absolute inset-0 pointer-events-none transition-colors duration-1000 z-0 ${bgFlash || "bg-transparent"}`}></div>
          <div className="absolute top-0 left-0 w-full h-full pointer-events-none z-[-1] bg-gradient-to-br from-[#0a0a0f] via-[#15151e] to-[#0a0a0f]"></div>

          {showSettings && <SettingsModal />}

          <div className="relative z-10 flex flex-col gap-6">
            <div className="flex justify-between items-center h-8">
              <div className="flex items-center gap-2">
                {!isLoaded ? (
                  <span className="text-xs text-white/40 flex items-center gap-1"><RefreshCw className="w-3 h-3 animate-spin" /> {loadingStatusText || `Loading ${loadProgress}%`}</span>
                ) : (
                  <button onClick={() => loadData(true)} className="flex items-center gap-1.5 text-xs font-medium text-white/40 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-2 py-1 rounded-md" title="Refresh Data">
                    <RefreshCw className="w-3 h-3" /> Refresh
                  </button>
                )}
                {(error || failedTabs.length > 0) && (
                  <div className="relative group">
                    <AlertCircle className="w-5 h-5 text-red-500 cursor-help" />
                    <div className="absolute left-0 top-full mt-2 w-48 p-2 bg-red-900/90 text-white text-[10px] rounded border border-red-500/50 hidden group-hover:block z-50">
                      {error && <div className="mb-1 font-bold">{error}</div>}
                      {failedTabs.length > 0 && (
                        <div>
                          <div className="opacity-70 mb-1">Failed Tabs:</div>
                          <ul className="list-disc pl-3 space-y-0.5">{failedTabs.map((t) => <li key={t.tab}>{t.tab}: {t.reason}</li>)}</ul>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
              <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><Settings className="w-5 h-5 text-white/50" /></button>
            </div>

            <div className="flex flex-col gap-4 w-full bg-[#13131a]/80 backdrop-blur-md p-4 rounded-3xl border border-white/5 shadow-xl">
              <div className="w-full overflow-x-auto pt-1 pb-1 custom-scrollbar -mx-1 px-1">
                <div className="flex gap-2 min-w-max">
                  {UI_CATEGORIES.map((tab) => (
                    <button key={tab} onClick={() => !isRolling && setActiveTab(tab)} disabled={isRolling} className={`px-4 py-2.5 rounded-lg text-[11px] font-bold uppercase tracking-wider transition-all duration-200 border ${activeTab === tab ? "bg-white text-black border-white shadow-[0_0_15px_rgba(255,255,255,0.2)] scale-105" : "bg-white/5 text-white/40 border-transparent hover:bg-white/10 hover:text-white"}`}>
                      {tab}
                    </button>
                  ))}
                </div>
              </div>

              <button onClick={triggerRoll} disabled={!isRolling && (!isLoaded || allItems.length === 0)} className={`group relative w-full h-28 rounded-2xl overflow-hidden transition-all duration-300 shadow-lg ${(!isRolling && allItems.length === 0) ? "scale-[0.99] opacity-90 cursor-not-allowed grayscale" : isRolling ? "opacity-75 brightness-90 saturate-50 hover:opacity-100 hover:brightness-100 hover:saturate-100" : "hover:scale-[1.01] active:scale-[0.98] hover:shadow-pink-500/20"}`}>
                <div className="absolute inset-0 bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 animate-gradient-x" style={{ backgroundSize: "400% 400%" }}></div>
                <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-30"></div>
                <style>{`
                  @keyframes gradient-x {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                  }
                  .animate-gradient-x {
                    animation: gradient-x 3s ease infinite;
                  }
                `}</style>
                <div className="relative z-10 flex items-center justify-center h-full gap-3">
                  {isRolling ? (<><RefreshCw className="w-6 h-6 animate-spin text-white/80" /><span className="text-lg font-black tracking-[0.2em] text-white drop-shadow-md">ROLLING...</span></>) : (<span className="text-lg font-black tracking-[0.2em] text-white drop-shadow-md">ROLL FOR LOOT</span>) }
                </div>
              </button>

              <div className="flex flex-col md:flex-row justify-between items-center gap-3">
                <div className="flex-1 bg-black/40 rounded-xl border border-white/5 relative group transition-colors hover:border-white/10">
                  <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none"><Filter className="w-3.5 h-3.5 text-white/30" /></div>
                  <CustomSelect
                    value={activeRarity}
                    onChange={setActiveRarity}
                    disabled={isRolling}
                    className="w-full"
                    buttonClassName="w-full bg-gradient-to-b from-[#191924] to-[#111118] border border-white/10 text-xs font-bold uppercase tracking-wide text-white/90 py-3 pl-10 pr-10 rounded-xl outline-none shadow-[0_8px_24px_rgba(0,0,0,0.35)] hover:border-white/20 hover:from-[#1f1f2b] hover:to-[#14141c] transition-colors focus:border-pink-500/70 focus:ring-2 focus:ring-pink-500/20"
                    optionClassName="uppercase tracking-wide text-xs font-bold"
                    options={[
                      { value: "Any", label: "Any Rarity" },
                      { value: "Common", label: "Common" },
                      { value: "Uncommon", label: "Uncommon" },
                      { value: "Rare", label: "Rare" },
                      { value: "Epic", label: "Epic" },
                      { value: "Legendary", label: "Legendary" },
                      { value: "Artifact", label: "Artifact" }
                    ]}
                  />
                </div>
                <div className="flex items-center gap-2 bg-black/40 p-1 rounded-xl border border-white/5">
                  <button onClick={() => handleAmountChange(-1)} disabled={isRolling} className="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-white/10 text-white/60 transition-colors disabled:opacity-30"><Minus className="w-3.5 h-3.5" /></button>
                  <span className="w-6 text-center font-mono font-bold text-sm">{rollAmount}</span>
                  <button onClick={() => handleAmountChange(1)} disabled={isRolling} className="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-white/10 text-white/60 transition-colors disabled:opacity-30"><Plus className="w-3.5 h-3.5" /></button>
                </div>
              </div>
            </div>

            <div className="relative overflow-hidden rounded-3xl bg-[#13131a]/50 border border-white/5 shadow-inner min-h-[360px] max-h-[60vh]">
              <div className="absolute inset-0 overflow-y-auto overflow-x-hidden p-3 custom-scrollbar">
                {isRolling && rollingItem && (
                  <div className="mb-3">
                    <HistoryItem item={rollingItem} isExpanded={false} isRollingView={!rollingItem.isFinalTick} onToggle={() => {}} />
                  </div>
                )}
                {history.length === 0 && !isRolling && (
                  <div className="flex flex-col items-center justify-center h-full text-white/10 italic text-sm">
                    <History className="w-12 h-12 mb-3 opacity-30" />
                    <p>Loot history will appear here</p>
                  </div>
                )}
                {history.map((item) => (
                  <div key={item.uniqueId} className="mb-3 last:mb-0">
                    <HistoryItem item={item} isExpanded={expandedId === item.uniqueId} onToggle={() => handleToggleExpand(item.uniqueId)} />
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const ValueDisplay = ({ copper }) => {
      const parts = formatMoney(copper);
      if (Array.isArray(parts)) {
        return (
          <div className="inline-flex items-center gap-1.5 bg-black/30 px-2 py-1 rounded-md border border-white/5 min-w-fit">
            {parts.map((p, idx) => (
              <span key={idx} className={`flex items-baseline gap-0.5 text-[10px] font-bold ${p.color}`}>
                {p.val}<span className="text-[1em] uppercase opacity-70 tracking-tighter">{p.unit}</span>
              </span>
            ))}
          </div>
        );
      }
      return null;
    };

    const HistoryItem = ({ item, isExpanded, onToggle, isRollingView = false }) => {
      const rarityKey = normalizeRarity(item.rarity);
      const rarityClass = RARITY_COLORS[rarityKey] || RARITY_COLORS["Common"];
      const rarityBgDot = RARITY_BG_DOT[rarityKey] || RARITY_BG_DOT["Common"];
      const rarityTextColor = RARITY_TEXT_COLORS[rarityKey] || RARITY_TEXT_COLORS["Common"];

      return (
        <div
          className={`
            relative w-full rounded-xl border backdrop-blur-sm overflow-hidden transition-all duration-300
            ${isRollingView
              ? `${rarityClass} border-opacity-50 bg-opacity-20 opacity-80`
              : isExpanded
                ? `${rarityClass} border-opacity-40 bg-opacity-10 shadow-lg scale-[1.01] z-10`
                : "bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20 cursor-pointer"}
            ${item.isNew ? "animate-flash" : ""}
          `}
          onClick={!isExpanded && !isRollingView ? onToggle : undefined}
        >
          <div className="p-3 md:p-4 flex items-center justify-between cursor-pointer gap-4" onClick={isExpanded && !isRollingView ? onToggle : undefined}>
            <div className="flex items-center gap-3 overflow-hidden flex-1 min-w-0">
              <div className={`w-2 h-2 rounded-full shrink-0 ${rarityBgDot}`} />
              <span className={`font-semibold text-sm md:text-base truncate transition-colors ${isRollingView ? "text-white/50" : rarityTextColor}`}>
                {item.name}
              </span>
            </div>
            {!isRollingView && (
              <div className="flex items-center gap-3 shrink-0 animate-fade-in-up">
                {item.value > 0 && <ValueDisplay copper={item.value} />}
                <span className={`hidden sm:inline-flex px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${rarityTextColor} bg-white/5 border border-white/5`}>
                  {rarityKey}
                </span>
                <div className={`text-white/30 transition-transform duration-300 ${isExpanded ? "rotate-180" : ""}`}><ChevronDown className="w-4 h-4" /></div>
              </div>
            )}
          </div>
          <div className={`overflow-hidden transition-[max-height] duration-500 ease-in-out ${isExpanded && !isRollingView ? "max-h-96 opacity-100" : "max-h-0 opacity-0"}`}>
            <div className="px-4 pb-4 pt-0">
              <div className="h-px w-full bg-white/5 mb-3"></div>
              <div className="sm:hidden mb-2"><span className={`text-[10px] font-bold uppercase tracking-wider opacity-60 ${rarityTextColor}`}>{rarityKey}</span></div>
              <p className="text-sm leading-relaxed text-slate-300 font-medium">{item.description}</p>
              <div className="mt-3 flex justify-end"><span className="text-[10px] text-white/20 uppercase tracking-widest">{item.category}</span></div>
            </div>
          </div>
        </div>
      );
    };

    const NotesPanel = () => {
      const STORAGE_KEY = "dm_notes_v1";
      const [notes, setNotes] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
          if (Array.isArray(saved) && saved.length > 0) return saved;
        } catch (err) {}
        const now = Date.now();
        return [{ id: `note-${now}`, title: "New Note", body: "", createdAt: now, updatedAt: now }];
      });
      const [activeId, setActiveId] = useState(() => notes[0]?.id);

      useEffect(() => {
        const id = setTimeout(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
        }, 500);
        return () => clearTimeout(id);
      }, [notes]);

      const activeNote = notes.find((note) => note.id === activeId) || notes[0];

      const updateActiveNote = (nextBody) => {
        const now = Date.now();
        setNotes((prev) =>
          prev.map((note) => {
            if (note.id !== activeId) return note;
            const titleSeed = nextBody.trim().split("\n")[0] || "Untitled Note";
            return {
              ...note,
              body: nextBody,
              title: titleSeed.slice(0, 30),
              updatedAt: now
            };
          })
        );
      };

      const createNote = () => {
        const now = Date.now();
        const note = { id: `note-${now}`, title: "New Note", body: "", createdAt: now, updatedAt: now };
        setNotes((prev) => [note, ...prev]);
        setActiveId(note.id);
      };

      const deleteNote = () => {
        if (!activeNote) return;
        setNotes((prev) => {
          const filtered = prev.filter((note) => note.id !== activeNote.id);
          if (filtered.length === 0) {
            const now = Date.now();
            const fresh = { id: `note-${now}`, title: "New Note", body: "", createdAt: now, updatedAt: now };
            setActiveId(fresh.id);
            return [fresh];
          }
          setActiveId(filtered[0].id);
          return filtered;
        });
      };

      return (
        <div className="grid grid-cols-1 xl:grid-cols-[0.5fr_1.5fr] gap-6">
          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-5 panel-glow flex flex-col gap-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs uppercase tracking-[0.3em] text-white/40">Notes</div>
                <div className="text-lg font-semibold text-white/90">Quick list</div>
              </div>
              <button
                onClick={createNote}
                className="px-3 py-1 rounded-full text-xs uppercase tracking-[0.2em] border border-white/10 text-white/60 hover:text-white hover:border-white/30 transition"
              >
                New
              </button>
            </div>

            <div className="flex flex-col gap-2 overflow-y-auto custom-scrollbar max-h-[60vh]">
              {notes.map((note) => (
                <button
                  key={note.id}
                  onClick={() => setActiveId(note.id)}
                  className={`text-left px-3 py-3 rounded-xl border transition ${
                    note.id === activeId
                      ? "bg-white text-black border-white shadow-lg shadow-white/10"
                      : "bg-white/5 border-transparent text-white/70 hover:bg-white/10 hover:text-white"
                  }`}
                >
                  <div className="text-xs uppercase tracking-[0.2em] opacity-70">{note.title || "Untitled Note"}</div>
                  <div className="text-[10px] opacity-50 mt-1">{new Date(note.updatedAt).toLocaleString()}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs uppercase tracking-[0.3em] text-white/40">Editor</div>
                <div className="text-lg font-semibold text-white/90">{activeNote?.title || "Untitled Note"}</div>
              </div>
              <button
                onClick={deleteNote}
                className="px-3 py-1 rounded-full text-xs uppercase tracking-[0.2em] border border-white/10 text-white/60 hover:text-white hover:border-white/30 transition"
              >
                Delete
              </button>
            </div>

            <textarea
              value={activeNote?.body || ""}
              onChange={(e) => updateActiveNote(e.target.value)}
              placeholder="Write quick notes for your session..."
              className="flex-1 min-h-[320px] bg-black/40 border border-white/10 rounded-2xl p-4 text-sm text-white/80 outline-none focus:border-pink-500 transition resize-none"
            />

            <div className="text-xs text-white/40">
              Saved locally in your browser storage. Word count: {(activeNote?.body || "").trim().split(/\s+/).filter(Boolean).length}
            </div>
          </div>
        </div>
      );
    };

    const HpTracker = () => {
      const STORAGE_KEY = "dm_hp_tracker_v1";
      const [rows, setRows] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
          if (Array.isArray(saved)) return saved;
        } catch (err) {}
        return [];
      });
      const [dragId, setDragId] = useState(null);
      const focusIdRef = useRef(null);

      useEffect(() => {
        const id = setTimeout(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
          } catch (err) {}
        }, 400);
        return () => clearTimeout(id);
      }, [rows]);

      const addRow = () => {
        const now = Date.now();
        const row = { id: `hp-${now}`, name: "", current: 1, max: 1 };
        setRows((prev) => [row, ...prev]);
        focusIdRef.current = row.id;
      };

      const updateRow = (id, patch) => {
        setRows((prev) =>
          prev.map((row) => {
            if (row.id !== id) return row;
            const next = { ...row, ...patch };
            const max = Number.isFinite(next.max) ? Math.max(0, next.max) : 0;
            const current = Number.isFinite(next.current) ? Math.max(0, next.current) : 0;
            next.max = max;
            next.current = Math.min(current, max);
            return next;
          })
        );
      };

      const removeRow = (id) => {
        setRows((prev) => prev.filter((row) => row.id !== id));
      };

      const handleDragStart = (id) => {
        setDragId(id);
      };

      const handleDrop = (id) => {
        if (!dragId || dragId === id) return;
        setRows((prev) => {
          const fromIndex = prev.findIndex((row) => row.id === dragId);
          const toIndex = prev.findIndex((row) => row.id === id);
          if (fromIndex === -1 || toIndex === -1) return prev;
          const next = [...prev];
          const [moved] = next.splice(fromIndex, 1);
          next.splice(toIndex, 0, moved);
          return next;
        });
        setDragId(null);
      };

      return (
        <div className="mt-auto -mx-6 px-6 text-xs max-h-[45vh] overflow-y-auto custom-scrollbar">
          <div className="flex flex-col gap-2">
            {rows.map((row) => (
              <HpRow
                key={row.id}
                row={row}
                onUpdate={updateRow}
                onRemove={removeRow}
                onDragStart={handleDragStart}
                onDrop={handleDrop}
                focusIdRef={focusIdRef}
              />
            ))}
          </div>

          <button
            onClick={addRow}
            className="w-full mt-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-[0.3em] text-white/70 hover:text-white transition"
          >
            + Add tracker
          </button>
        </div>
      );
    };

    const HpRow = ({ row, onUpdate, onRemove, onDragStart, onDrop, focusIdRef }) => {
      const inputRef = useRef(null);

      useEffect(() => {
        if (focusIdRef.current === row.id && inputRef.current) {
          inputRef.current.focus();
          inputRef.current.select();
          focusIdRef.current = null;
        }
      }, [row.id, focusIdRef]);

      const parseValue = (value) => {
        const parsed = parseInt(value, 10);
        return Number.isFinite(parsed) ? parsed : 0;
      };

      return (
        <div
          className="flex flex-col gap-2 bg-black/30 border border-white/10 rounded-xl px-2 py-2 w-full"
          onDragOver={(e) => e.preventDefault()}
          onDrop={() => onDrop(row.id)}
        >
          <div className="flex items-center gap-2">
            <button
              className="text-white/40 hover:text-white cursor-grab active:cursor-grabbing px-1 self-center"
              draggable
              onDragStart={() => onDragStart(row.id)}
              title="Drag to reorder"
              type="button"
            >
              
            </button>
            <input
              ref={inputRef}
              value={row.name}
              onChange={(e) => onUpdate(row.id, { name: e.target.value })}
              placeholder="Name"
              className="flex-1 bg-transparent text-white/80 text-xs outline-none placeholder:text-white/30"
            />
            <button
              onClick={() => onRemove(row.id)}
              className="text-white/40 hover:text-white px-1 ml-auto"
              title="Remove"
              type="button"
            >
              
            </button>
          </div>
          <div className="flex items-center gap-2 pl-6">
            <input
              value={row.current}
              onChange={(e) => onUpdate(row.id, { current: parseValue(e.target.value) })}
              className="w-14 bg-black/40 border border-white/10 rounded-lg text-center text-xs text-white/80 outline-none"
              inputMode="numeric"
            />
            <span className="text-white/30">/</span>
            <input
              value={row.max}
              onChange={(e) => onUpdate(row.id, { max: parseValue(e.target.value) })}
              className="w-14 bg-black/40 border border-white/10 rounded-lg text-center text-xs text-white/80 outline-none"
              inputMode="numeric"
            />
          </div>
        </div>
      );
    };

    const CustomSelect = ({ value, options, onChange, disabled = false, className = "", buttonClassName = "", optionClassName = "" }) => {
      const [open, setOpen] = useState(false);
      const containerRef = useRef(null);
      const selected = options.find((opt) => opt.value === value);

      useEffect(() => {
        if (!open) return;
        const handleClickOutside = (event) => {
          if (containerRef.current && !containerRef.current.contains(event.target)) {
            setOpen(false);
          }
        };
        const handleKeyDown = (event) => {
          if (event.key === "Escape") {
            setOpen(false);
          }
        };
        document.addEventListener("mousedown", handleClickOutside);
        document.addEventListener("keydown", handleKeyDown);
        return () => {
          document.removeEventListener("mousedown", handleClickOutside);
          document.removeEventListener("keydown", handleKeyDown);
        };
      }, [open]);

      const handleSelect = (nextValue) => {
        onChange(nextValue);
        setOpen(false);
      };

      return (
        <div ref={containerRef} className={`relative ${className}`}>
          <button
            type="button"
            disabled={disabled}
            onClick={() => setOpen((prev) => !prev)}
            className={`w-full text-left ${buttonClassName} ${disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer"}`}
            aria-haspopup="listbox"
            aria-expanded={open}
          >
            <div className="flex items-center justify-between gap-3">
              <span className="truncate">{selected?.label || "Select..."}</span>
              <ChevronDown className={`w-3.5 h-3.5 text-white/40 transition-transform ${open ? "rotate-180" : ""}`} />
            </div>
          </button>

          {open && !disabled && (
            <div className="absolute z-20 mt-2 w-full rounded-xl border border-white/10 bg-[#12121a] shadow-[0_18px_40px_rgba(0,0,0,0.45)] overflow-hidden">
              <div className="max-h-60 overflow-y-auto custom-scrollbar">
                {options.map((opt) => (
                  <button
                    key={opt.value}
                    type="button"
                    onClick={() => handleSelect(opt.value)}
                    className={`w-full text-left px-3 py-2 text-sm transition ${optionClassName} ${
                      opt.value === value ? "bg-white/10 text-white" : "text-white/70 hover:bg-white/5"
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const ArcaneSurgePanel = () => {
      const [result, setResult] = useState("Ready to unleash a surge.");
      const [critical, setCritical] = useState(false);
      const [forceCritical, setForceCritical] = useState(false);
      const [isRolling, setIsRolling] = useState(false);

      const rollSurge = () => {
        if (isRolling) return;
        setIsRolling(true);
        setResult("Gathering arcane energy...");
        setCritical(false);

        setTimeout(() => {
          const isCritical = forceCritical || Math.random() < 0.1;
          if (isCritical) {
            const text = CRITICAL_EFFECTS[Math.floor(Math.random() * CRITICAL_EFFECTS.length)];
            setResult(text);
            setCritical(true);
          } else {
            const text = SURGE_EFFECTS[Math.floor(Math.random() * SURGE_EFFECTS.length)];
            setResult(text);
            setCritical(false);
          }
        }, 400);

        setTimeout(() => setIsRolling(false), 5000);
      };

      return (
        <div className="grid grid-cols-1 xl:grid-cols-[0.7fr_1.3fr] gap-6">
          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-6">
            <div>
              <div className="text-xs uppercase tracking-[0.3em] text-white/40">Arcane Controls</div>
              <div className="text-xl font-semibold text-white/90">Surge engine</div>
            </div>
            <button
              onClick={rollSurge}
              disabled={isRolling}
              className={`relative overflow-hidden rounded-2xl px-6 py-4 text-lg font-black tracking-[0.2em] uppercase transition-all ${
                isRolling ? "opacity-50 cursor-wait" : "hover:scale-[1.02] hover:shadow-pink-500/20"
              } bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 text-white shadow-lg`}
            >
              {isRolling ? "Charging..." : "Arcane Surge"}
            </button>

            <label className="flex items-center gap-3 text-xs uppercase tracking-[0.3em] text-white/60">
              <input
                type="checkbox"
                checked={forceCritical}
                onChange={(e) => setForceCritical(e.target.checked)}
                className="w-4 h-4 accent-pink-500"
              />
              Desperate
            </label>

            <div className="text-xs text-white/40 leading-relaxed">
              Critical chance is 10% (or forced).
            </div>
          </div>

          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-8 panel-glow flex flex-col justify-center items-center min-h-[360px]">
            <div className={`text-sm uppercase tracking-[0.6em] mb-6 ${critical ? "text-pink-400 critical-label" : "text-white/30"}`}>
              {critical ? "CRITICAL" : "STABLE"}
            </div>
            <div className={`text-2xl md:text-3xl text-center font-semibold leading-relaxed ${critical ? "gradient-text" : "text-white/80"}`}>
              {result}
            </div>
          </div>
        </div>
      );
    };

    const BackgroundPanel = () => {
      const [apiKey] = useState(BACKGROUND_DEFAULT_API_KEY);
      const [selectedStyleId, setSelectedStyleId] = useState(() => localStorage.getItem(BACKGROUND_STORAGE_KEYS.styleId) || BACKGROUND_STYLES[0].id);
      const [styleOverrides, setStyleOverrides] = useState(() => {
        try {
          const stored = localStorage.getItem(BACKGROUND_STORAGE_KEYS.styleOverrides);
          if (stored) return JSON.parse(stored);
        } catch (err) {}
        return {};
      });
      const [userPrompt, setUserPrompt] = useState(() => localStorage.getItem(BACKGROUND_STORAGE_KEYS.prompt) || "");
      const [sceneContext, setSceneContext] = useState(() => localStorage.getItem(BACKGROUND_STORAGE_KEYS.context) || "any");
      const [imageUrl, setImageUrl] = useState("");
      const [isGenerating, setIsGenerating] = useState(false);
      const [isExtractingReference, setIsExtractingReference] = useState(false);
      const [isTransformingEnvironment, setIsTransformingEnvironment] = useState(false);
      const [transformEnvironmentTarget, setTransformEnvironmentTarget] = useState("");
      const [error, setError] = useState("");
      const [elapsedSeconds, setElapsedSeconds] = useState(0);
      const [referenceImage, setReferenceImage] = useState(null);
      const [referenceStyleImage, setReferenceStyleImage] = useState(null);
      const [isEditingStyles, setIsEditingStyles] = useState(false);
      const [editDraft, setEditDraft] = useState([]);
      const fileInputRef = useRef(null);
      const fileInputStyleRef = useRef(null);

      useEffect(() => {
        localStorage.setItem(BACKGROUND_STORAGE_KEYS.styleId, selectedStyleId);
      }, [selectedStyleId]);

      useEffect(() => {
        localStorage.setItem(BACKGROUND_STORAGE_KEYS.prompt, userPrompt);
      }, [userPrompt]);

      useEffect(() => {
        localStorage.setItem(BACKGROUND_STORAGE_KEYS.context, sceneContext);
      }, [sceneContext]);

      const mergedStyles = useMemo(() => {
        if (styleOverrides && Array.isArray(styleOverrides.styles)) {
          return styleOverrides.styles;
        }
        const overrides = styleOverrides || {};
        return BACKGROUND_STYLES.map((style) => {
          const override = overrides[style.id];
          if (!override) return style;
          return {
            ...style,
            primer: typeof override.primer === "string" ? override.primer : style.primer,
            contexts: Array.isArray(override.contexts) ? override.contexts : style.contexts
          };
        });
      }, [styleOverrides]);

      const selectedStyle = mergedStyles.find((style) => style.id === selectedStyleId) || mergedStyles[0];
      const availableContexts = selectedStyle.contexts || [];
      const selectedContext = availableContexts.find((ctx) => ctx.id === sceneContext) || null;
      const activeReferenceImage = referenceImage || referenceStyleImage;
      const canGenerate = apiKey.trim().length > 0 && userPrompt.trim().length > 0 && !isGenerating && !isExtractingReference && !isTransformingEnvironment;

      const slugify = (value) =>
        value
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "") || `custom-${Date.now()}`;

      const openStyleEditor = () => {
        const draft = mergedStyles.map((style) => ({
          id: style.id,
          label: style.label,
          primer: style.primer || "",
          contexts: Array.isArray(style.contexts)
            ? style.contexts.map((ctx) => ({ id: ctx.id, label: ctx.label, primer: ctx.primer || "" }))
            : []
        }));
        setEditDraft(draft);
        setIsEditingStyles(true);
      };

      const saveStyleEditor = () => {
        const normalized = editDraft.map((style) => {
          const id = slugify(style.label || "style");
          const contexts = Array.isArray(style.contexts)
            ? style.contexts.map((ctx) => ({
                id: slugify(ctx.label || "context"),
                label: ctx.label?.trim() || "Context",
                primer: ctx.primer || ""
              }))
            : [];
          return {
            id,
            label: style.label?.trim() || id,
            primer: style.primer || "",
            contexts
          };
        });
        const nextOverrides = { styles: normalized };
        setStyleOverrides(nextOverrides);
        localStorage.setItem(BACKGROUND_STORAGE_KEYS.styleOverrides, JSON.stringify(nextOverrides));
        setIsEditingStyles(false);
      };

      useEffect(() => {
        if (!selectedStyle || !mergedStyles.find((s) => s.id === selectedStyleId)) {
          if (mergedStyles.length > 0) {
            setSelectedStyleId(mergedStyles[0].id);
          }
        }
      }, [mergedStyles, selectedStyleId, selectedStyle]);

      useEffect(() => {
        if (sceneContext !== "any" && !availableContexts.some((ctx) => ctx.id === sceneContext)) {
          setSceneContext("any");
        }
      }, [sceneContext, availableContexts]);

      useEffect(() => {
        if (!isGenerating) {
          setElapsedSeconds(0);
          return;
        }
        const start = Date.now();
        const id = setInterval(() => {
          setElapsedSeconds(Math.floor((Date.now() - start) / 1000));
        }, 1000);
        return () => clearInterval(id);
      }, [isGenerating]);

      const buildPrompt = () => {
        const artstylePrimer = referenceStyleImage ? REF_STYLE_ARTSTYLE_PRIMER : BACKGROUND_ARTSTYLE_PRIMER;
        const lines = [
          artstylePrimer,
          `Main environment content: ${userPrompt.trim()}`,
          `Additional environment feel when applicable: ${selectedStyle.primer}`,
          "Constraints: 16:9 landscape, 2048x1152, no text, no UI."
        ];
        if (sceneContext && sceneContext !== "any" && selectedContext) {
          lines.push(`Scene context: ${selectedContext.label}. ${selectedContext.primer}`);
        }
        if (referenceImage) {
          lines.push("From reference image, use only the environment, the feeling, the space and its content and reimagine it to the image generation environment. Do not copy resolution, lighting, or artstyle; keep the fixed artstyle and constraints above.");
        }
        if (referenceStyleImage) {
          lines.push("Copy the exact art style from ref style image. Strongly match the ref style image for art style rendering, brushwork, texture treatment, color grading, edge softness/hardness, material painting style, and lighting mood. Use that style as highest-priority visual guidance. CONTENT FIREWALL: Do not transfer composition, objects, characters, poses, layout, or specific scene elements from the ref style image.");
        }
        return lines.join("\n");
      };

      const handleGenerate = async () => {
        if (!canGenerate) return;
        setIsGenerating(true);
        setError("");
        const fullPrompt = buildPrompt();
        console.log("[Background Generator] Prompt:\n", fullPrompt);

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${encodeURIComponent(apiKey.trim())}`;
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: activeReferenceImage
                    ? [{ inlineData: { mimeType: activeReferenceImage.mimeType, data: activeReferenceImage.data } }, { text: fullPrompt }]
                    : [{ text: fullPrompt }]
                }
              ]
            })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const parts = data?.candidates?.[0]?.content?.parts || [];
          const inlinePart = parts.find((part) => part.inlineData && part.inlineData.data);

          if (!inlinePart) {
            throw new Error("No image data returned from the model.");
          }

          const mimeType = inlinePart.inlineData.mimeType || "image/png";
          const imageData = inlinePart.inlineData.data;
          const nextUrl = `data:${mimeType};base64,${imageData}`;
          setImageUrl(nextUrl);
          setTimeout(() => {
            const link = document.createElement("a");
            link.href = nextUrl;
            link.download = `background-${selectedStyleId || "scene"}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }, 0);
        } catch (err) {
          setError(err.message || "Failed to generate image.");
        } finally {
          setIsGenerating(false);
        }
      };

      const handleTransformEnvironment = async () => {
        if (!userPrompt.trim() || !transformEnvironmentTarget.trim() || isTransformingEnvironment) return;
        setError("");
        setIsTransformingEnvironment(true);
        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(apiKey.trim())}`;
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [
                    {
                      text:
                        "Rewrite the scene description so it is set in the target environment while preserving intent, subject focus, camera/composition cues, and level of detail. Output only rewritten scene text.\n\n" +
                        `Target environment: ${transformEnvironmentTarget.trim()}\n\n` +
                        `Current scene description:\n${userPrompt.trim()}`
                    }
                  ]
                }
              ]
            })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const parts = data?.candidates?.[0]?.content?.parts || [];
          const rewrittenText = parts
            .map((part) => part?.text || "")
            .join("\n")
            .trim();

          if (!rewrittenText) {
            throw new Error("No transformed text returned from the model.");
          }

          setUserPrompt(rewrittenText);
        } catch (err) {
          setError(err.message || "Failed to transform scene text.");
        } finally {
          setIsTransformingEnvironment(false);
        }
      };

      const handleReferenceUpload = (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          if (typeof result !== "string") {
            setError("Failed to read reference image.");
            return;
          }
          const match = result.match(/^data:(.*);base64,(.*)$/);
          if (!match) {
            setError("Unsupported reference image format.");
            return;
          }
          setReferenceStyleImage(null);
          if (fileInputStyleRef.current) {
            fileInputStyleRef.current.value = "";
          }
          setReferenceImage({ mimeType: match[1], data: match[2], name: file.name });
        };
        reader.onerror = () => {
          setError("Failed to load reference image.");
        };
        reader.readAsDataURL(file);
      };

      const handleExtractReferenceDetails = async () => {
        if (!referenceImage || isExtractingReference) return;
        setError("");
        setIsExtractingReference(true);
        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(apiKey.trim())}`;
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [
                    { inlineData: { mimeType: referenceImage.mimeType, data: referenceImage.data } },
                    { text: "From reference image, extract into text only the environment, the feeling, the space and its content." }
                  ]
                }
              ]
            })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const parts = data?.candidates?.[0]?.content?.parts || [];
          const extractedText = parts
            .map((part) => part?.text || "")
            .join("\n")
            .trim();

          if (!extractedText) {
            throw new Error("No extracted text returned from the model.");
          }

          setUserPrompt((prev) => {
            const base = (prev || "").trim();
            return base ? `${base}\n${extractedText}` : extractedText;
          });
        } catch (err) {
          setError(err.message || "Failed to extract reference details.");
        } finally {
          setIsExtractingReference(false);
        }
      };

      const handleReferenceStyleUpload = (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          if (typeof result !== "string") {
            setError("Failed to read style reference image.");
            return;
          }
          const match = result.match(/^data:(.*);base64,(.*)$/);
          if (!match) {
            setError("Unsupported style reference image format.");
            return;
          }
          setReferenceImage(null);
          if (fileInputRef.current) {
            fileInputRef.current.value = "";
          }
          setReferenceStyleImage({ mimeType: match[1], data: match[2], name: file.name });
        };
        reader.onerror = () => {
          setError("Failed to load style reference image.");
        };
        reader.readAsDataURL(file);
      };

      const clearReferenceImage = () => {
        setReferenceImage(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = "";
        }
      };

      const clearReferenceStyleImage = () => {
        setReferenceStyleImage(null);
        if (fileInputStyleRef.current) {
          fileInputStyleRef.current.value = "";
        }
      };

      return (
        <div className="flex flex-col gap-6">
          {isEditingStyles && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-6">
              <div className="w-full max-w-3xl bg-[#13131a] border border-white/10 rounded-3xl p-6 shadow-2xl flex flex-col gap-4">
                <div className="flex items-center justify-between">
                  <div className="text-xs uppercase tracking-[0.4em] text-white/50">Edit Prompts</div>
                  <div className="flex items-center gap-3">
                    <button
                      type="button"
                      onClick={() => {
                        const next = [
                          ...editDraft,
                          { label: "New Style", primer: "", contexts: [] }
                        ];
                        setEditDraft(next);
                      }}
                      className="text-[10px] uppercase tracking-[0.3em] text-white/50 hover:text-white transition"
                    >
                      Add Style
                    </button>
                    <button
                      type="button"
                      onClick={() => setIsEditingStyles(false)}
                      className="text-white/40 hover:text-white transition"
                    >
                      <X className="w-4 h-4" />
                    </button>
                  </div>
                </div>

                <div className="flex flex-col gap-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                  {editDraft.map((style, styleIndex) => (
                    <div key={`${style.label || "style"}-${styleIndex}`} className="border border-white/5 rounded-2xl p-4 bg-black/30">
                      <div className="flex items-center justify-between mb-2">
                        <div className="text-xs uppercase tracking-[0.3em] text-white/50">{style.label || "Style"}</div>
                        <button
                          type="button"
                          onClick={() => {
                            if (!window.confirm(`Remove style "${style.label || "Untitled"}"?`)) return;
                            const next = editDraft.filter((_, idx) => idx !== styleIndex);
                            setEditDraft(next);
                          }}
                          className="text-[10px] uppercase tracking-[0.3em] text-rose-300/70 hover:text-rose-200 transition"
                        >
                          Remove
                        </button>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-[1fr] gap-3 mb-3">
                        <input
                          value={style.label}
                          onChange={(e) => {
                            const next = [...editDraft];
                            next[styleIndex] = { ...next[styleIndex], label: e.target.value };
                            setEditDraft(next);
                          }}
                          className="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white/80 outline-none focus:border-pink-500 transition"
                          placeholder="Style label"
                        />
                      </div>
                      <textarea
                        value={style.primer}
                        onChange={(e) => {
                          const next = [...editDraft];
                          next[styleIndex] = { ...next[styleIndex], primer: e.target.value };
                          setEditDraft(next);
                        }}
                        className="w-full min-h-[80px] bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white/80 outline-none focus:border-pink-500 transition resize-y"
                        placeholder="Style primer..."
                      />
                      <div className="mt-3 flex items-center justify-between">
                        <div className="text-[10px] uppercase tracking-[0.3em] text-white/40">Contexts</div>
                        <button
                          type="button"
                          onClick={() => {
                            const next = [...editDraft];
                            const nextContexts = Array.isArray(next[styleIndex].contexts) ? [...next[styleIndex].contexts] : [];
                            nextContexts.push({ label: "New Context", primer: "" });
                            next[styleIndex] = { ...next[styleIndex], contexts: nextContexts };
                            setEditDraft(next);
                          }}
                          className="text-[10px] uppercase tracking-[0.3em] text-white/50 hover:text-white transition"
                        >
                          Add Context
                        </button>
                      </div>
                      {Array.isArray(style.contexts) && style.contexts.length > 0 && (
                        <div className="mt-3 flex flex-col gap-3">
                          {style.contexts.map((ctx, ctxIndex) => (
                            <div key={`${style.label || "style"}-${ctx.label || "context"}-${ctxIndex}`} className="bg-black/30 border border-white/5 rounded-xl p-3">
                              <div className="flex items-center justify-between mb-2">
                                <div className="text-[10px] uppercase tracking-[0.3em] text-white/50">{ctx.label || "Context"}</div>
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (!window.confirm(`Remove context "${ctx.label || "Untitled"}"?`)) return;
                                    const next = [...editDraft];
                                    const nextContexts = [...next[styleIndex].contexts];
                                    nextContexts.splice(ctxIndex, 1);
                                    next[styleIndex] = { ...next[styleIndex], contexts: nextContexts };
                                    setEditDraft(next);
                                  }}
                                  className="text-[10px] uppercase tracking-[0.3em] text-rose-300/70 hover:text-rose-200 transition"
                                >
                                  Remove
                                </button>
                              </div>
                              <div className="grid grid-cols-1 md:grid-cols-[1fr] gap-3 mb-2">
                                <input
                                  value={ctx.label}
                                  onChange={(e) => {
                                    const next = [...editDraft];
                                    const nextContexts = [...next[styleIndex].contexts];
                                    nextContexts[ctxIndex] = { ...nextContexts[ctxIndex], label: e.target.value };
                                    next[styleIndex] = { ...next[styleIndex], contexts: nextContexts };
                                    setEditDraft(next);
                                  }}
                                  className="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white/80 outline-none focus:border-pink-500 transition"
                                  placeholder="Context label"
                                />
                              </div>
                              <textarea
                                value={ctx.primer}
                                onChange={(e) => {
                                  const next = [...editDraft];
                                  const nextContexts = [...next[styleIndex].contexts];
                                  nextContexts[ctxIndex] = { ...nextContexts[ctxIndex], primer: e.target.value };
                                  next[styleIndex] = { ...next[styleIndex], contexts: nextContexts };
                                  setEditDraft(next);
                                }}
                                className="w-full min-h-[60px] bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white/80 outline-none focus:border-pink-500 transition resize-y"
                                placeholder="Context primer..."
                              />
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div className="flex items-center justify-end gap-3">
                  <button
                    type="button"
                    onClick={() => setIsEditingStyles(false)}
                    className="px-4 py-2 rounded-xl border border-white/10 text-xs uppercase tracking-[0.3em] text-white/50 hover:text-white hover:border-white/30 transition"
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    onClick={saveStyleEditor}
                    className="px-5 py-2 rounded-xl bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 text-white text-xs uppercase tracking-[0.3em] shadow-lg"
                  >
                    Save
                  </button>
                </div>
              </div>
            </div>
          )}
          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-6">
            <div className="grid grid-cols-1 lg:grid-cols-[0.5fr_1.5fr] gap-4">
              <div className="flex flex-col h-full justify-between gap-4">
                <CustomSelect
                  value={selectedStyleId}
                  onChange={setSelectedStyleId}
                  className="w-full flex-1"
                  buttonClassName="w-full bg-gradient-to-b from-[#191924] to-[#111118] border border-white/10 rounded-xl px-3 py-3 text-sm text-white/90 outline-none focus:border-pink-500/70 focus:ring-2 focus:ring-pink-500/20 shadow-[0_8px_24px_rgba(0,0,0,0.35)] hover:border-white/20 hover:from-[#1f1f2b] hover:to-[#14141c] transition-colors"
                  optionClassName="text-sm"
                  options={mergedStyles.map((style) => ({ value: style.id, label: style.label }))}
                />

                <CustomSelect
                  value={sceneContext}
                  onChange={setSceneContext}
                  className="w-full flex-1"
                  buttonClassName="w-full bg-gradient-to-b from-[#191924] to-[#111118] border border-white/10 rounded-xl px-3 py-3 text-sm text-white/90 outline-none focus:border-pink-500/70 focus:ring-2 focus:ring-pink-500/20 shadow-[0_8px_24px_rgba(0,0,0,0.35)] hover:border-white/20 hover:from-[#1f1f2b] hover:to-[#14141c] transition-colors"
                  optionClassName="text-sm"
                  options={[
                    { value: "any", label: "Any" },
                    ...availableContexts.map((ctx) => ({
                      value: ctx.id,
                      label: ctx.label
                    }))
                  ]}
                />
                <button
                  type="button"
                  onClick={openStyleEditor}
                  className="self-start text-[10px] uppercase tracking-[0.4em] text-white/40 hover:text-white/70 transition"
                >
                  Edit
                </button>
              </div>

              <div className="flex flex-col gap-3">
                <div className="grid grid-cols-1 lg:grid-cols-[1.3fr_0.7fr] gap-4">
                  <div className="flex flex-col gap-2">
                    <textarea
                      value={userPrompt}
                      onChange={(e) => setUserPrompt(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.ctrlKey && e.key === "Enter") {
                          e.preventDefault();
                          handleGenerate();
                        }
                      }}
                      placeholder="Describe the location..."
                      className="min-h-[120px] bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm text-white/80 outline-none focus:border-pink-500 transition resize-none"
                    />
                    <div className="flex items-center gap-2">
                      <input
                        value={transformEnvironmentTarget}
                        onChange={(e) => setTransformEnvironmentTarget(e.target.value)}
                        placeholder="Transform scene to environment..."
                        className="flex-1 bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-white/80 outline-none focus:border-cyan-400 transition"
                      />
                      <button
                        type="button"
                        onClick={handleTransformEnvironment}
                        disabled={!userPrompt.trim() || !transformEnvironmentTarget.trim() || isTransformingEnvironment || isGenerating || isExtractingReference}
                        className={`px-4 py-2 rounded-xl border text-xs font-semibold transition ${
                          !userPrompt.trim() || !transformEnvironmentTarget.trim() || isTransformingEnvironment || isGenerating || isExtractingReference
                            ? "border-white/10 bg-white/5 text-white/30 cursor-not-allowed"
                            : "border-cyan-400/30 bg-cyan-500/10 text-cyan-200 hover:bg-cyan-500/20 hover:border-cyan-300/40"
                        }`}
                      >
                        {isTransformingEnvironment ? "..." : "->"}
                      </button>
                    </div>
                  </div>

                  <div className="flex flex-col gap-3">
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        onClick={() => fileInputRef.current?.click()}
                        className="w-full px-4 py-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-[0.3em] text-white/70 hover:text-white transition"
                      >
                        Reference
                      </button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        onChange={handleReferenceUpload}
                        className="hidden"
                      />
                      <button
                        type="button"
                        onClick={() => fileInputStyleRef.current?.click()}
                        className="w-full px-4 py-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-[0.3em] text-white/70 hover:text-white transition"
                      >
                        Ref style
                      </button>
                      <input
                        ref={fileInputStyleRef}
                        type="file"
                        accept="image/*"
                        onChange={handleReferenceStyleUpload}
                        className="hidden"
                      />
                    </div>
                    {referenceImage && (
                      <div className="flex items-center gap-2 text-xs text-white/60">
                        <span className="truncate max-w-[180px]">{referenceImage.name}</span>
                        <button
                          type="button"
                          onClick={clearReferenceImage}
                          className="px-2 py-1 rounded-lg border border-white/10 text-white/50 hover:text-white hover:border-white/30 transition"
                        >
                          Clear
                        </button>
                      </div>
                    )}
                    {referenceStyleImage && (
                      <div className="flex items-center gap-2 text-xs text-white/60">
                        <span className="px-2 py-1 rounded-lg border border-cyan-300/40 bg-cyan-400/10 text-cyan-200 text-[10px] uppercase tracking-[0.2em]">Style lock on</span>
                        <span className="truncate max-w-[180px]">Ref style: {referenceStyleImage.name}</span>
                        <button
                          type="button"
                          onClick={clearReferenceStyleImage}
                          className="px-2 py-1 rounded-lg border border-white/10 text-white/50 hover:text-white hover:border-white/30 transition"
                        >
                          Clear
                        </button>
                      </div>
                    )}
                    <button
                      type="button"
                      onClick={handleExtractReferenceDetails}
                      disabled={!referenceImage || isExtractingReference || isGenerating}
                      className={`w-full px-4 py-3 rounded-2xl border text-xs uppercase tracking-[0.3em] transition ${
                        !referenceImage || isExtractingReference || isGenerating
                          ? "border-white/10 bg-white/5 text-white/30 cursor-not-allowed"
                          : "border-cyan-400/30 bg-cyan-500/10 text-cyan-200 hover:bg-cyan-500/20 hover:border-cyan-300/40"
                      }`}
                    >
                      {isExtractingReference ? "Extracting..." : "Extract ref"}
                    </button>
                    <button
                      onClick={handleGenerate}
                      disabled={!canGenerate}
                      className={`relative w-full overflow-hidden rounded-2xl px-6 py-4 text-sm font-black tracking-[0.3em] uppercase transition-all ${
                        canGenerate ? "hover:scale-[1.02] hover:shadow-pink-500/20" : "opacity-50 cursor-not-allowed"
                      } bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 text-white shadow-lg`}
                    >
                      {isGenerating ? "Generating..." : "Generate"}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {error && (
              <div className="bg-rose-500/10 border border-rose-500/30 text-rose-200 text-xs rounded-xl px-3 py-2">
                {error}
              </div>
            )}

          </div>

          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-4">
            <div className="relative w-full aspect-[16/9] rounded-2xl border border-white/10 bg-black/40 overflow-hidden">
              {imageUrl && (
                <img
                  src={imageUrl}
                  alt="Generated background"
                  className={`w-full h-full object-cover transition-opacity duration-700 ${isGenerating ? "opacity-0" : "opacity-100"}`}
                />
              )}
              {(!imageUrl || isGenerating) && (
                <div className={`absolute inset-0 flex flex-col items-center justify-center text-white/20 text-sm ${isGenerating ? "animate-breathe" : ""}`}>
                  <ImageIcon className="w-20 h-20 mb-3 opacity-50" />
                </div>
              )}
              {isGenerating && (
                <div className="absolute inset-x-0 bottom-4 flex items-center justify-center">
                  <div className="px-4 py-2 rounded-full bg-black/50 border border-white/10 text-xs uppercase tracking-[0.4em] text-white/70">
                    {String(Math.floor(elapsedSeconds / 60)).padStart(2, "0")}:{String(elapsedSeconds % 60).padStart(2, "0")}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const PortraitPanel = () => {
      const [apiKey] = useState(BACKGROUND_DEFAULT_API_KEY);
      const [selectedStyleId, setSelectedStyleId] = useState(() => localStorage.getItem(PORTRAIT_STORAGE_KEYS.styleId) || PORTRAIT_STYLES[0].id);
      const [selectedRaceId, setSelectedRaceId] = useState(() => localStorage.getItem(PORTRAIT_STORAGE_KEYS.raceId) || PORTRAIT_RACES[0].id);
      const [userPrompt, setUserPrompt] = useState(() => localStorage.getItem(PORTRAIT_STORAGE_KEYS.prompt) || "");
      const [imageUrl, setImageUrl] = useState("");
      const [isGenerating, setIsGenerating] = useState(false);
      const [error, setError] = useState("");
      const [elapsedSeconds, setElapsedSeconds] = useState(0);
      const [referenceImage, setReferenceImage] = useState(null);
      const [referenceStyleImage, setReferenceStyleImage] = useState(null);
      const fileInputRef = useRef(null);
      const fileInputStyleRef = useRef(null);

      useEffect(() => {
        localStorage.setItem(PORTRAIT_STORAGE_KEYS.styleId, selectedStyleId);
      }, [selectedStyleId]);

      useEffect(() => {
        localStorage.setItem(PORTRAIT_STORAGE_KEYS.raceId, selectedRaceId);
      }, [selectedRaceId]);

      useEffect(() => {
        localStorage.setItem(PORTRAIT_STORAGE_KEYS.prompt, userPrompt);
      }, [userPrompt]);

      const selectedStyle = PORTRAIT_STYLES.find((style) => style.id === selectedStyleId) || PORTRAIT_STYLES[0];
      const selectedRace = PORTRAIT_RACES.find((race) => race.id === selectedRaceId) || PORTRAIT_RACES[0];
      const activeReferenceImage = referenceImage || referenceStyleImage;
      const canGenerate = apiKey.trim().length > 0 && userPrompt.trim().length > 0 && !isGenerating;

      useEffect(() => {
        if (!isGenerating) {
          setElapsedSeconds(0);
          return;
        }
        const start = Date.now();
        const id = setInterval(() => {
          setElapsedSeconds(Math.floor((Date.now() - start) / 1000));
        }, 1000);
        return () => clearInterval(id);
      }, [isGenerating]);

      const buildPrompt = () => {
        const artstylePrimer = referenceStyleImage ? REF_STYLE_ARTSTYLE_PRIMER : BACKGROUND_ARTSTYLE_PRIMER;
        const lines = [
          "Fantasy character portrait. 3:4 aspect ratio, 1536x2048, no text, no UI.",
          artstylePrimer,
          `Style: ${selectedStyle.primer}`,
          `Race: ${selectedRace.primer}`,
          `Character instructions: ${userPrompt.trim()}. Only one character should be visible, from the waist up. Focus on clear depiction of character's identity, outfit, and silhouette.`
        ];
        if (referenceImage) {
          lines.push("From reference image, extract only the character's identity, outfit, and silhouette. Do not copy artstyle or lighting.");
        }
        if (referenceStyleImage) {
          lines.push("Strongly match the ref style image for art style rendering, brushwork, texture treatment, color grading, edge softness/hardness, material painting style, and lighting mood. Use that style as highest-priority visual guidance. CONTENT FIREWALL: Do not transfer composition, objects, characters, poses, layout, or specific scene elements from the ref style image.");
          lines.push("Enforce strong style transfer from ref style image while keeping character identity, outfit, silhouette, and pose from the prompt only.");
        }
        return lines.join("\n");
      };

      const handleGenerate = async () => {
        if (!canGenerate) return;
        setIsGenerating(true);
        setError("");
        const fullPrompt = buildPrompt();
        console.log("[Portrait Generator] Prompt:\n", fullPrompt);

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${encodeURIComponent(apiKey.trim())}`;
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: activeReferenceImage
                    ? [{ inlineData: { mimeType: activeReferenceImage.mimeType, data: activeReferenceImage.data } }, { text: fullPrompt }]
                    : [{ text: fullPrompt }]
                }
              ]
            })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const parts = data?.candidates?.[0]?.content?.parts || [];
          const inlinePart = parts.find((part) => part.inlineData && part.inlineData.data);

          if (!inlinePart) {
            throw new Error("No image data returned from the model.");
          }

          const mimeType = inlinePart.inlineData.mimeType || "image/png";
          const imageData = inlinePart.inlineData.data;
          const nextUrl = `data:${mimeType};base64,${imageData}`;
          setImageUrl(nextUrl);
          setTimeout(() => {
            const link = document.createElement("a");
            link.href = nextUrl;
            link.download = `portrait-${selectedRaceId || "character"}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }, 0);
        } catch (err) {
          setError(err.message || "Failed to generate image.");
        } finally {
          setIsGenerating(false);
        }
      };

      const handleReferenceUpload = (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          if (typeof result !== "string") {
            setError("Failed to read reference image.");
            return;
          }
          const match = result.match(/^data:(.*);base64,(.*)$/);
          if (!match) {
            setError("Unsupported reference image format.");
            return;
          }
          setReferenceStyleImage(null);
          if (fileInputStyleRef.current) {
            fileInputStyleRef.current.value = "";
          }
          setReferenceImage({ mimeType: match[1], data: match[2], name: file.name });
        };
        reader.onerror = () => {
          setError("Failed to load reference image.");
        };
        reader.readAsDataURL(file);
      };

      const handleReferenceStyleUpload = (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          if (typeof result !== "string") {
            setError("Failed to read style reference image.");
            return;
          }
          const match = result.match(/^data:(.*);base64,(.*)$/);
          if (!match) {
            setError("Unsupported style reference image format.");
            return;
          }
          setReferenceImage(null);
          if (fileInputRef.current) {
            fileInputRef.current.value = "";
          }
          setReferenceStyleImage({ mimeType: match[1], data: match[2], name: file.name });
        };
        reader.onerror = () => {
          setError("Failed to load style reference image.");
        };
        reader.readAsDataURL(file);
      };

      const clearReferenceImage = () => {
        setReferenceImage(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = "";
        }
      };

      const clearReferenceStyleImage = () => {
        setReferenceStyleImage(null);
        if (fileInputStyleRef.current) {
          fileInputStyleRef.current.value = "";
        }
      };

      return (
        <div className="flex flex-col gap-6">
          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-6">
            <div className="grid grid-cols-1 lg:grid-cols-[0.5fr_1.5fr] gap-4">
              <div className="flex flex-col h-full justify-between gap-4">
                <CustomSelect
                  value={selectedStyleId}
                  onChange={setSelectedStyleId}
                  className="w-full flex-1"
                  buttonClassName="w-full bg-gradient-to-b from-[#191924] to-[#111118] border border-white/10 rounded-xl px-3 py-3 text-sm text-white/90 outline-none focus:border-pink-500/70 focus:ring-2 focus:ring-pink-500/20 shadow-[0_8px_24px_rgba(0,0,0,0.35)] hover:border-white/20 hover:from-[#1f1f2b] hover:to-[#14141c] transition-colors"
                  optionClassName="text-sm"
                  options={PORTRAIT_STYLES.map((style) => ({ value: style.id, label: style.label }))}
                />

                <CustomSelect
                  value={selectedRaceId}
                  onChange={setSelectedRaceId}
                  className="w-full flex-1"
                  buttonClassName="w-full bg-gradient-to-b from-[#191924] to-[#111118] border border-white/10 rounded-xl px-3 py-3 text-sm text-white/90 outline-none focus:border-pink-500/70 focus:ring-2 focus:ring-pink-500/20 shadow-[0_8px_24px_rgba(0,0,0,0.35)] hover:border-white/20 hover:from-[#1f1f2b] hover:to-[#14141c] transition-colors"
                  optionClassName="text-sm"
                  options={PORTRAIT_RACES.map((race) => ({ value: race.id, label: race.label }))}
                />
              </div>

              <div className="flex flex-col gap-3">
                <div className="grid grid-cols-1 lg:grid-cols-[1.3fr_0.7fr] gap-4">
                  <textarea
                    value={userPrompt}
                    onChange={(e) => setUserPrompt(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.ctrlKey && e.key === "Enter") {
                        e.preventDefault();
                        handleGenerate();
                      }
                    }}
                    placeholder="Describe the character..."
                    className="min-h-[120px] bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm text-white/80 outline-none focus:border-pink-500 transition resize-none"
                  />

                  <div className="flex flex-col gap-3">
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        onClick={() => fileInputRef.current?.click()}
                        className="w-full px-4 py-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-[0.3em] text-white/70 hover:text-white transition"
                      >
                        Reference
                      </button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        onChange={handleReferenceUpload}
                        className="hidden"
                      />
                      <button
                        type="button"
                        onClick={() => fileInputStyleRef.current?.click()}
                        className="w-full px-4 py-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs uppercase tracking-[0.3em] text-white/70 hover:text-white transition"
                      >
                        Ref style
                      </button>
                      <input
                        ref={fileInputStyleRef}
                        type="file"
                        accept="image/*"
                        onChange={handleReferenceStyleUpload}
                        className="hidden"
                      />
                    </div>
                    {referenceImage && (
                      <div className="flex items-center gap-2 text-xs text-white/60">
                        <span className="truncate max-w-[180px]">{referenceImage.name}</span>
                        <button
                          type="button"
                          onClick={clearReferenceImage}
                          className="px-2 py-1 rounded-lg border border-white/10 text-white/50 hover:text-white hover:border-white/30 transition"
                        >
                          Clear
                        </button>
                      </div>
                    )}
                    {referenceStyleImage && (
                      <div className="flex items-center gap-2 text-xs text-white/60">
                        <span className="px-2 py-1 rounded-lg border border-cyan-300/40 bg-cyan-400/10 text-cyan-200 text-[10px] uppercase tracking-[0.2em]">Style lock on</span>
                        <span className="truncate max-w-[180px]">Ref style: {referenceStyleImage.name}</span>
                        <button
                          type="button"
                          onClick={clearReferenceStyleImage}
                          className="px-2 py-1 rounded-lg border border-white/10 text-white/50 hover:text-white hover:border-white/30 transition"
                        >
                          Clear
                        </button>
                      </div>
                    )}
                    <button
                      onClick={handleGenerate}
                      disabled={!canGenerate}
                      className={`relative w-full overflow-hidden rounded-2xl px-6 py-4 text-sm font-black tracking-[0.3em] uppercase transition-all ${
                        canGenerate ? "hover:scale-[1.02] hover:shadow-pink-500/20" : "opacity-50 cursor-not-allowed"
                      } bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 text-white shadow-lg`}
                    >
                      {isGenerating ? "Generating..." : "Generate"}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {error && (
              <div className="bg-rose-500/10 border border-rose-500/30 text-rose-200 text-xs rounded-xl px-3 py-2">
                {error}
              </div>
            )}
          </div>

          <div className="bg-[#13131a]/90 border border-white/5 rounded-3xl p-6 panel-glow flex flex-col gap-4">
            <div className="relative w-full max-w-[50%] aspect-[3/4] rounded-2xl border border-white/10 bg-black/40 overflow-hidden">
              {imageUrl && (
                <img
                  src={imageUrl}
                  alt="Generated portrait"
                  className={`w-full h-full object-cover transition-opacity duration-700 ${isGenerating ? "opacity-0" : "opacity-100"}`}
                />
              )}
              {(!imageUrl || isGenerating) && (
                <div className={`absolute inset-0 flex flex-col items-center justify-center text-white/20 text-sm ${isGenerating ? "animate-breathe" : ""}`}>
                  <ImageIcon className="w-20 h-20 mb-3 opacity-50" />
                </div>
              )}
              {isGenerating && (
                <div className="absolute inset-x-0 bottom-4 flex items-center justify-center">
                  <div className="px-4 py-2 rounded-full bg-black/50 border border-white/10 text-xs uppercase tracking-[0.4em] text-white/70">
                    {String(Math.floor(elapsedSeconds / 60)).padStart(2, "0")}:{String(elapsedSeconds % 60).padStart(2, "0")}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
