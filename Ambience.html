<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loot Roller</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>
    
    <style>
        body { background-color: #0a0a0f; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0f; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        select option {
            background-color: #1a1a20;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Minus = (props) => <IconBase {...props}><path d="M5 12h14"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M2 7h4"/><path d="M13 7h4"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const Ban = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></IconBase>;
        const FileUp = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="m9 15 3 3 3-3"/></IconBase>;

        // --- CONFIGURATION ---
        const DEFAULT_SHEET_ID = "1mjI0ROF2BPhbBX61Dykcd15viTV3Ef0tp6iIv__e_5M";
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwK4yHMGbdW26LwFysBrGy2Qtnt1p1NEiOn0S4ue9ZqoaloN7Nz0-xd9FtKIJqCSlsj/exec";
        
        const SHEET_TABS = ["Weapons", "Armor", "Potions", "Scrolls", "Treasure", "Trade goods", "Wondrous", "Trinkets"];
        const UI_CATEGORIES = ["Random", "Equipment", ...SHEET_TABS];

        // --- DEMO DATA (Fallback) ---
        const FALLBACK_ITEMS = [
            { name: "Demo Longsword", rarity: "Common", description: "A basic sword. Configure your Script URL in settings to load real items!", value: 1500, category: "Weapons" },
            { name: "Demo Potion", rarity: "Uncommon", description: "Heals 2d4+2. Configure your Script URL in settings to load real items!", value: 5000, category: "Potions" },
            { name: "Demo Shield", rarity: "Rare", description: "+1 AC. Configure your Script URL in settings to load real items!", value: 45000, category: "Armor" },
            { name: "Demo Ring", rarity: "Legendary", description: "A ring of power. Configure your Script URL in settings to load real items!", value: 500000, category: "Wondrous" }
        ];

        const RARITY_MAPPING = {
          "Common": ["Common", "None"], "Uncommon": ["Uncommon"], "Rare": ["Rare"],
          "Epic": ["Very Rare", "VeryRare"], "Legendary": ["Legendary"], "Artifact": ["Artifact"]
        };
        const RARITY_WEIGHTS = { "Common": 5500, "Uncommon": 3000, "Rare": 1000, "Very Rare": 400, "Legendary": 99, "Artifact": 1 };
        const RARITY_TEXT_COLORS = { "Common": "text-slate-400", "Uncommon": "text-emerald-400", "Rare": "text-cyan-400", "Very Rare": "text-purple-400", "Epic": "text-purple-400", "Legendary": "text-amber-400", "Artifact": "text-rose-500" };
        const RARITY_COLORS = { "Common": "border-slate-600 shadow-slate-500/10 bg-slate-500/5", "Uncommon": "border-emerald-600 shadow-emerald-500/20 bg-emerald-500/10", "Rare": "border-cyan-500 shadow-cyan-500/20 bg-cyan-500/10", "Very Rare": "border-purple-500 shadow-purple-500/20 bg-purple-500/10", "Epic": "border-purple-500 shadow-purple-500/20 bg-purple-500/10", "Legendary": "border-amber-500 shadow-amber-500/40 bg-amber-500/10", "Artifact": "border-rose-600 shadow-rose-500/50 bg-rose-500/10" };
        const RARITY_FLASH_COLORS = { "Common": "bg-slate-500/10", "Uncommon": "bg-emerald-500/20", "Rare": "bg-cyan-500/20", "Very Rare": "bg-purple-500/25", "Epic": "bg-purple-500/25", "Legendary": "bg-amber-500/30", "Artifact": "bg-rose-600/40" };
        const RARITY_BG_DOT = { "Common": "bg-slate-500", "Uncommon": "bg-emerald-500", "Rare": "bg-cyan-500", "Very Rare": "bg-purple-500", "Epic": "bg-purple-500", "Legendary": "bg-amber-500", "Artifact": "bg-rose-600" };

        const normalizeRarity = (r) => { if (!r) return "Common"; const l = r.trim().toLowerCase(); if (l==='common'||l==='none') return "Common"; if (l==='uncommon') return "Uncommon"; if (l==='rare') return "Rare"; if (l==='very rare'||l==='veryrare'||l==='epic') return "Very Rare"; if (l==='legendary') return "Legendary"; if (l==='artifact') return "Artifact"; return "Common"; };
        
        const parseCSV = (text) => {
          const rows=[]; let r=[]; let c=''; let q=false;
          for(let i=0;i<text.length;i++){
            const char=text[i], next=text[i+1];
            if(char==='"'){ if(q && next==='"'){c+='"';i++;}else{q=!q;} }
            else if(char===','&&!q){r.push(c.trim());c='';}
            else if((char==='\r'||char==='\n')&&!q){if(c||r.length>0)r.push(c.trim());if(r.length>0)rows.push(r);r=[];c='';if(char==='\r'&&next==='\n')i++;}
            else{c+=char;}
          }
          if(c||r.length>0){r.push(c.trim());rows.push(r);}
          return rows;
        };

        const formatMoney = (val) => {
          if (!val || isNaN(val)) return null;
          let cp = parseInt(val, 10);
          const pp = Math.floor(cp/1000); cp %= 1000;
          const gp = Math.floor(cp/100); cp %= 100;
          const sp = Math.floor(cp/10); cp %= 10;
          const parts = [];
          if (pp > 0) parts.push({ val: pp, unit: 'p', color: 'text-slate-200' });
          if (gp > 0) parts.push({ val: gp, unit: 'g', color: 'text-yellow-400' });
          if (sp > 0) parts.push({ val: sp, unit: 's', color: 'text-slate-400' });
          if (cp > 0) parts.push({ val: cp, unit: 'c', color: 'text-orange-600' });
          if (parts.length === 0) return { val: 0, unit: 'c', color: 'text-slate-600' };
          return parts;
        };

        // --- RETRY & TIMEOUT HELPER ---
        const fetchWithRetry = async (url, retries = 3, delay = 1000, timeout = 20000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(id);
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.text();
                } catch (err) {
                    const isTimeout = err.name === 'AbortError';
                    const errorMsg = isTimeout ? `Timeout (${timeout}ms)` : err.message;
                    
                    if (i === retries - 1) throw new Error(errorMsg);
                    await new Promise(res => setTimeout(res, delay * (i + 1))); 
                }
            }
        };

        const App = () => {
          const [sheetId, setSheetId] = useState(() => localStorage.getItem('loot_roller_sheet_id') || DEFAULT_SHEET_ID);
          const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem('loot_roller_script_url') || DEFAULT_SCRIPT_URL);
          const [instantRoll, setInstantRoll] = useState(() => localStorage.getItem('loot_roller_instant_roll') === 'true');
          
          const [showSettings, setShowSettings] = useState(false);
          const [activeTab, setActiveTab] = useState("Random");
          const [activeRarity, setActiveRarity] = useState("Any");
          const [rollAmount, setRollAmount] = useState(1);
          const [history, setHistory] = useState([]);
          const [expandedId, setExpandedId] = useState(null); 
          const [isRolling, setIsRolling] = useState(false);
          const [rollingItem, setRollingItem] = useState(null); 
          const [bgFlash, setBgFlash] = useState(null); 
          const [allItems, setAllItems] = useState([]); 
          const [isLoaded, setIsLoaded] = useState(false);
          const [loadProgress, setLoadProgress] = useState(0);
          const [error, setError] = useState(null);
          const [failedTabs, setFailedTabs] = useState([]);
          const [loadingStatusText, setLoadingStatusText] = useState("");
          
          const stopRollingRef = useRef(false);
          const currentIntervalRef = useRef(null);
          const fileInputRef = useRef(null);

          useEffect(() => { loadData(false); }, [scriptUrl, sheetId]);

          const normalizeItem = (rawItem, category) => ({
             name: rawItem.name || rawItem.Name || "Unknown",
             rarity: normalizeRarity(rawItem.rarity || rawItem.Rarity),
             description: rawItem.description || rawItem.Description || rawItem.desc || "",
             value: parseInt((rawItem.value || rawItem.Value || "0").toString().replace(/\D/g,'')) || 0,
             category: category,
             id: Math.random().toString(36).substr(2, 9)
          });

          const loadData = async (forceRefresh = false) => {
             setIsLoaded(false); setLoadProgress(0); setError(null); setFailedTabs([]);
             
             const CACHE_KEY_DATA = `loot_data_${scriptUrl || sheetId || 'demo'}`;
             if (!forceRefresh) {
                 const cachedData = localStorage.getItem(CACHE_KEY_DATA);
                 if (cachedData) {
                     try {
                         const parsed = JSON.parse(cachedData);
                         if (parsed && parsed.length > 0) {
                             setAllItems(parsed);
                             setIsLoaded(true);
                             setLoadProgress(100);
                             return;
                         }
                     } catch (e) { console.error("Cache error", e); }
                 }
             }

             // Apps Script (Fast)
             if (scriptUrl) {
                 try {
                     setLoadingStatusText("Connecting to Script...");
                     setLoadProgress(10);
                     const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(scriptUrl)}`;
                     
                     // Use AbortController for script fetch too
                     const controller = new AbortController();
                     const id = setTimeout(() => controller.abort(), 25000); // 25s timeout for script
                     
                     const response = await fetch(proxyUrl, { signal: controller.signal });
                     clearTimeout(id);
                     
                     if (response.ok) {
                         setLoadProgress(50);
                         setLoadingStatusText("Processing Data...");
                         const data = await response.json();
                         processAndFinish(data);
                         return;
                     }
                 } catch (e) { 
                     console.warn("Proxy script fetch failed, trying direct...", e);
                     try {
                        const response = await fetch(scriptUrl);
                        if (response.ok) {
                            const data = await response.json();
                            processAndFinish(data);
                            return;
                        }
                     } catch (directErr) { console.warn("Direct fetch failed", directErr); }
                 }
             }

             // Google Sheets Legacy (Robust Sequential Fetch)
             if (sheetId) {
                setLoadingStatusText("Loading Sheets...");
                let collectedItems = [];
                const failed = [];
                
                for (let i = 0; i < SHEET_TABS.length; i++) {
                    const tabName = SHEET_TABS[i];
                    setLoadingStatusText(`Loading ${tabName}...`);
                    
                    const targetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}&t=${Date.now()}`;
                    const url = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                    
                    try {
                        const text = await fetchWithRetry(url, 3, 1000, 20000); // 3 retries, 20s timeout
                        const rows = parseCSV(text);
                        if (rows.length > 1) {
                            const headers = rows[0].map(h => h.toLowerCase().trim());
                            const nameIdx = headers.findIndex(h => h.includes('name'));
                            const rarityIdx = headers.findIndex(h => h.includes('rarity'));
                            const descIdx = headers.findIndex(h => h.includes('desc') || h.includes('entry'));
                            const valIdx = headers.findIndex(h => h === 'value' || h === 'cost' || h === 'price');

                            if (nameIdx !== -1) {
                                const tabItems = rows.slice(1).map(row => ({
                                    name: row[nameIdx] || "Unknown",
                                    rarity: rarityIdx !== -1 ? normalizeRarity(row[rarityIdx]) : "Common",
                                    description: descIdx !== -1 ? row[descIdx] : "",
                                    value: valIdx !== -1 ? parseInt(row[valIdx].replace(/\D/g,'')) || 0 : 0,
                                    category: tabName,
                                    id: Math.random().toString(36).substr(2, 9)
                                })).filter(i => i.name && i.name !== "Unknown");
                                
                                collectedItems = [...collectedItems, ...tabItems];
                                setAllItems(prev => [...prev, ...tabItems]);
                            } else { failed.push({ tab: tabName, reason: "No Name Column" }); }
                        }
                    } catch (e) {
                        console.warn(`Failed tab ${tabName}`, e);
                        failed.push({ tab: tabName, reason: e.message || "Error" });
                    } finally {
                        setLoadProgress(Math.round(((i + 1) / SHEET_TABS.length) * 100));
                        await new Promise(r => setTimeout(r, 100)); // Small yield
                    }
                }

                if (collectedItems.length > 0) {
                    finishLoad(collectedItems, failed, CACHE_KEY_DATA);
                    setFailedTabs(failed); // Store full error objects
                    if (failed.length > 0) setError(`Partial Load. ${failed.length} tabs failed.`);
                    return;
                }
             }
             
             setError("Could not load from Sheets. Using Demo Data.");
             finishLoad(FALLBACK_ITEMS, [], CACHE_KEY_DATA);
          };
          
          const processAndFinish = (data) => {
             const processed = [];
             const content = data.contents ? JSON.parse(data.contents) : data;
             
             Object.keys(content).forEach(cat => {
                if (Array.isArray(content[cat])) {
                    content[cat].forEach(item => processed.push(normalizeItem(item, cat)));
                }
             });
             finishLoad(processed, [], `loot_data_${scriptUrl || sheetId || 'demo'}`);
          };

          const finishLoad = (items, failed = [], cacheKey) => {
              setAllItems(items);
              setFailedTabs(failed);
              setIsLoaded(true);
              setLoadProgress(100);
              localStorage.setItem(cacheKey, JSON.stringify(items));
          };

          const handleFileUpload = (event) => {
              const file = event.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (e) => {
                  try {
                      const data = JSON.parse(e.target.result);
                      const processed = [];
                      if (Array.isArray(data)) {
                          data.forEach(item => processed.push(normalizeItem(item, "Custom")));
                      } else {
                          Object.keys(data).forEach(cat => {
                              if(Array.isArray(data[cat])) data[cat].forEach(item => processed.push(normalizeItem(item, cat)));
                          });
                      }
                      finishLoad(processed, [], `loot_data_custom`);
                      alert(`Loaded ${processed.length} items from file!`);
                      setShowSettings(false);
                  } catch (err) { alert("Invalid JSON file"); }
              };
              reader.readAsText(file);
          };

          const saveSettings = (newUrl, newInstant) => {
            const urlChanged = newUrl !== scriptUrl;
            setScriptUrl(newUrl); setInstantRoll(newInstant);
            localStorage.setItem('loot_roller_script_url', newUrl);
            localStorage.setItem('loot_roller_instant_roll', newInstant);
            setShowSettings(false);
            if (urlChanged) loadData(true);
          };

          const handleAmountChange = (delta) => { if (!isRolling) setRollAmount(prev => Math.max(1, Math.min(10, prev + delta))); };
          const handleToggleExpand = (id) => { setExpandedId(expandedId === id ? null : id); };
          const getPool = () => {
            let pool = [];
            if (activeTab === "Random") pool = allItems;
            else if (activeTab === "Equipment") pool = allItems.filter(i => i.category === "Weapons" || i.category === "Armor");
            else pool = allItems.filter(i => i.category === activeTab);
            if (activeRarity !== "Any") {
              const targets = RARITY_MAPPING[activeRarity] || [activeRarity];
              pool = pool.filter(i => targets.map(r => normalizeRarity(r)).includes(normalizeRarity(i.rarity)));
            }
            return pool;
          };

          const pickItemFromPool = (pool) => {
            if (pool.length === 0) return { name: "Nothing Found", rarity: "Common", description: "Check filters.", category: "System" };
            if (activeRarity !== "Any") return pool[Math.floor(Math.random() * pool.length)];
            
            const groups = { "Common": [], "Uncommon": [], "Rare": [], "Very Rare": [], "Legendary": [], "Artifact": [] };
            pool.forEach(item => { groups[normalizeRarity(item.rarity)]?.push(item) || groups["Common"].push(item); });
            
            let roll = Math.floor(Math.random() * Object.values(RARITY_WEIGHTS).reduce((a, b) => a + b, 0));
            let selectedRarity = "Common";
            for (const [r, w] of Object.entries(RARITY_WEIGHTS)) { if (roll < w) { selectedRarity = r; break; } roll -= w; }
            
            const order = ["Artifact", "Legendary", "Very Rare", "Rare", "Uncommon", "Common"];
            const idx = order.indexOf(selectedRarity);
            for (let i = idx; i < order.length; i++) if (groups[order[i]].length) return groups[order[i]][Math.floor(Math.random() * groups[order[i]].length)];
            for (let i = order.length - 1; i >= 0; i--) if (groups[order[i]].length) return groups[order[i]][Math.floor(Math.random() * groups[order[i]].length)];
            return pool[0];
          };

          const triggerRoll = async () => {
            if (isRolling) { stopRollingRef.current = true; return; }
            const pool = getPool();
            if (pool.length === 0) return;
            setIsRolling(true); stopRollingRef.current = false; setExpandedId(null);
            for (let i = 0; i < rollAmount; i++) { if (stopRollingRef.current) break; await performSingleRoll(i === rollAmount - 1, pool); }
            setIsRolling(false); setRollingItem(null);
          };

          const performSingleRoll = (isLast, pool) => {
            return new Promise((resolve) => {
              const finalItem = pickItemFromPool(pool);
              const finalize = () => {
                if (stopRollingRef.current) { resolve(); return; }
                setRollingItem(null);
                setBgFlash(RARITY_FLASH_COLORS[normalizeRarity(finalItem.rarity)]);
                setTimeout(() => setBgFlash(null), 800); // Slower flash fade
                
                const item = { ...finalItem, uniqueId: Date.now() + Math.random(), timestamp: new Date().toLocaleTimeString(), isNew: true };
                setHistory(p => [item, ...p]); setExpandedId(item.uniqueId);
                setTimeout(() => setHistory(p => p.map(i => i.uniqueId === item.uniqueId ? {...i, isNew: false} : i)), 500);
                setTimeout(resolve, 300);
              };
              if (instantRoll) { finalize(); return; }
              
              // === ANIMATION CONFIGURATION ===
              let tick = 0; 
              const totalTicks = 50; 
              
              const runLoop = () => {
                if (stopRollingRef.current) { clearTimeout(currentIntervalRef.current); resolve(); return; }
                
                // SHOW WINNING ITEM FOR LAST 2 TICKS
                // This creates the "lock on" effect before it drops
                if (tick >= totalTicks - 2) {
                     setRollingItem({ ...finalItem, temp: true, isFinalTick: true });
                } else {
                     const randomVisual = pool[Math.floor(Math.random() * pool.length)];
                     setRollingItem({ ...randomVisual, temp: true, isFinalTick: false });
                }
                
                tick++;
                if (tick >= totalTicks) {
                    // Hold for 800ms before finalize to satisfy "shown at end" request
                    setTimeout(finalize, 800);
                } else {
                  const progress = tick / totalTicks;
                  const delay = Math.max(30, 20 + (600 * Math.pow(progress, 4))); 
                  currentIntervalRef.current = setTimeout(runLoop, delay);
                }
              };
              runLoop();
            });
          };

          // SETTINGS MODAL CONTENT
          const SettingsModal = () => (
             <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in-up">
                  <div className="bg-[#1a1a20] border border-white/10 rounded-2xl w-full max-w-md p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                    <button onClick={() => setShowSettings(false)} className="absolute top-4 right-4 text-white/40 hover:text-white"><X /></button>
                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><Settings className="w-5 h-5 text-pink-400" /> Settings</h2>
                    <div className="space-y-6">
                      
                      {/* 1. Recommended: Script URL */}
                      <div>
                        <label className="block text-xs font-bold uppercase tracking-wider text-white/50 mb-2">Google Apps Script URL (Fast)</label>
                        <input type="text" value={scriptUrl} onChange={(e) => setScriptUrl(e.target.value)} placeholder="https://script.google.com/macros/s/..."
                          className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-3 text-sm text-white focus:border-pink-500 outline-none transition-colors" />
                        <p className="text-[10px] text-white/20 mt-1">Recommended for fast loading.</p>
                      </div>

                      {/* 2. Instant Roll Toggle */}
                      <div className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                         <div className="flex flex-col">
                            <span className="text-sm font-bold text-white/90">Instant Roll</span>
                            <span className="text-[10px] text-white/40">Skip animation</span>
                         </div>
                         <button onClick={() => setInstantRoll(!instantRoll)} className={`w-12 h-6 rounded-full relative transition-colors duration-300 ${instantRoll ? 'bg-pink-600' : 'bg-white/10'}`}>
                           <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all duration-300 ${instantRoll ? 'left-7' : 'left-1'}`}></div>
                         </button>
                      </div>

                      <button onClick={() => saveSettings(scriptUrl, instantRoll)} className="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-900/20 transition-all active:scale-95">Save Changes</button>
                      
                      {/* 3. Manual Import */}
                      <div className="pt-4 border-t border-white/5 mt-4">
                        <label className="block text-xs font-bold uppercase tracking-wider text-white/50 mb-2">Manual Import</label>
                        <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-white py-2 rounded-lg border border-white/10 transition-colors text-sm">
                            <FileUp className="w-4 h-4" /> Load JSON/CSV File
                        </button>
                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".json,.csv" />
                      </div>

                    </div>
                  </div>
                </div>
          );

          return (
            <div className="min-h-screen w-full bg-[#0a0a0f] text-white font-sans overflow-hidden flex flex-col relative selection:bg-pink-500 selection:text-white">
              <div className={`absolute inset-0 pointer-events-none transition-colors duration-1000 z-0 ${bgFlash || 'bg-transparent'}`}></div>
              <div className="absolute top-0 left-0 w-full h-full pointer-events-none z-[-1] bg-gradient-to-br from-[#0a0a0f] via-[#15151e] to-[#0a0a0f]"></div>

              {showSettings && <SettingsModal />}

              <div className="relative z-10 flex flex-col h-screen w-full max-w-4xl mx-auto p-4 md:p-6">
                <div className="flex-shrink-0 flex flex-col gap-4 mb-6">
                    <div className="flex justify-between items-center h-8">
                       <div className="flex items-center gap-2">
                          {!isLoaded ? (
                              <span className="text-xs text-white/40 flex items-center gap-1"><RefreshCw className="w-3 h-3 animate-spin"/> {loadingStatusText || `Loading ${loadProgress}%`}</span>
                          ) : (
                              <button onClick={() => loadData(true)} className="flex items-center gap-1.5 text-xs font-medium text-white/40 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-2 py-1 rounded-md" title="Refresh Data">
                                 <RefreshCw className="w-3 h-3" /> Refresh
                              </button>
                          )}
                          {(error || failedTabs.length > 0) && (
                            <div className="relative group">
                                <AlertCircle className="w-5 h-5 text-red-500 cursor-help" />
                                <div className="absolute left-0 top-full mt-2 w-48 p-2 bg-red-900/90 text-white text-[10px] rounded border border-red-500/50 hidden group-hover:block z-50">
                                    {error && <div className="mb-1 font-bold">{error}</div>}
                                    {failedTabs.length > 0 && <div><div className="opacity-70 mb-1">Failed Tabs:</div><ul className="list-disc pl-3 space-y-0.5">{failedTabs.map(t => <li key={t.tab}>{t.tab}: {t.reason}</li>)}</ul></div>}
                                </div>
                            </div>
                          )}
                       </div>
                       <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><Settings className="w-5 h-5 text-white/50" /></button>
                    </div>

                    <div className="flex flex-col gap-4 w-full bg-[#13131a]/80 backdrop-blur-md p-4 rounded-3xl border border-white/5 shadow-xl">
                      <div className="w-full overflow-x-auto pt-1 pb-1 scrollbar-hide -mx-1 px-1">
                        <div className="flex gap-2 min-w-max">
                          {UI_CATEGORIES.map((tab) => (
                            <button key={tab} onClick={() => !isRolling && setActiveTab(tab)} disabled={isRolling} className={`px-4 py-2.5 rounded-lg text-[11px] font-bold uppercase tracking-wider transition-all duration-200 border ${activeTab === tab ? 'bg-white text-black border-white shadow-[0_0_15px_rgba(255,255,255,0.2)] scale-105' : 'bg-white/5 text-white/40 border-transparent hover:bg-white/10 hover:text-white'}`}>{tab}</button>
                          ))}
                        </div>
                      </div>

                      <button onClick={triggerRoll} disabled={!isRolling && (!isLoaded || allItems.length === 0)} className={`group relative w-full h-32 rounded-2xl overflow-hidden transition-all duration-300 shadow-lg ${(!isRolling && allItems.length === 0) ? 'scale-[0.99] opacity-90 cursor-not-allowed grayscale' : isRolling ? 'opacity-75 brightness-90 saturate-50 hover:opacity-100 hover:brightness-100 hover:saturate-100' : 'hover:scale-[1.01] active:scale-[0.98] hover:shadow-pink-500/20'}`}>
                        <div className="absolute inset-0 bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 animate-gradient-x" style={{backgroundSize: '400% 400%'}}></div>
                        <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-30"></div>
                        
                        <style>{`
                            @keyframes gradient-x {
                                0% { background-position: 0% 50%; }
                                50% { background-position: 100% 50%; }
                                100% { background-position: 0% 50%; }
                            }
                            .animate-gradient-x {
                                animation: gradient-x 3s ease infinite;
                            }
                        `}</style>
                        
                        <div className="relative z-10 flex items-center justify-center h-full gap-3">
                          {isRolling ? (<><RefreshCw className="w-6 h-6 animate-spin text-white/80" /><span className="text-xl font-black tracking-[0.2em] text-white drop-shadow-md">ROLLING...</span></>) : (<span className="text-xl font-black tracking-[0.2em] text-white drop-shadow-md">ROLL FOR LOOT</span>)}
                        </div>
                      </button>

                      <div className="flex justify-between items-center gap-3">
                         <div className="flex-1 bg-black/40 rounded-xl border border-white/5 relative group transition-colors hover:border-white/10">
                            <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none"><Filter className="w-3.5 h-3.5 text-white/30" /></div>
                            <select value={activeRarity} onChange={(e) => setActiveRarity(e.target.value)} disabled={isRolling} className="w-full bg-[#13131a] text-xs font-bold uppercase tracking-wide text-white/80 py-3 pl-10 pr-4 rounded-xl appearance-none outline-none cursor-pointer hover:bg-white/5 transition-colors disabled:opacity-50">
                              <option value="Any">Any Rarity</option>
                              <option value="Common">Common</option>
                              <option value="Uncommon">Uncommon</option>
                              <option value="Rare">Rare</option>
                              <option value="Epic">Epic</option>
                              <option value="Legendary">Legendary</option>
                              <option value="Artifact">Artifact</option>
                            </select>
                            <div className="absolute inset-y-0 right-3 flex items-center pointer-events-none text-white/20"><ChevronDown className="w-3 h-3" /></div>
                         </div>
                         <div className="flex items-center gap-2 bg-black/40 p-1 rounded-xl border border-white/5">
                            <button onClick={() => handleAmountChange(-1)} disabled={isRolling} className="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-white/10 text-white/60 transition-colors disabled:opacity-30"><Minus className="w-3.5 h-3.5" /></button>
                            <span className="w-6 text-center font-mono font-bold text-sm">{rollAmount}</span>
                            <button onClick={() => handleAmountChange(1)} disabled={isRolling} className="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-white/10 text-white/60 transition-colors disabled:opacity-30"><Plus className="w-3.5 h-3.5" /></button>
                         </div>
                      </div>
                    </div>
                </div>

                <div className="flex-1 relative overflow-hidden rounded-3xl bg-[#13131a]/50 border border-white/5 shadow-inner">
                    <div className="absolute inset-0 overflow-y-auto overflow-x-hidden p-3 custom-scrollbar">
                      {isRolling && rollingItem && (<div className="mb-3"><HistoryItem item={rollingItem} isExpanded={false} isRollingView={!rollingItem.isFinalTick} onToggle={()=>{}} /></div>)}
                      {history.length === 0 && !isRolling && (
                        <div className="flex flex-col items-center justify-center h-full text-white/10 italic text-sm">
                          <History className="w-12 h-12 mb-3 opacity-30" />
                          <p>Loot history will appear here</p>
                        </div>
                      )}
                      {history.map((item) => (
                        <div key={item.uniqueId} className="mb-3 last:mb-0">
                            <HistoryItem item={item} isExpanded={expandedId === item.uniqueId} onToggle={() => handleToggleExpand(item.uniqueId)} />
                        </div>
                      ))}
                    </div>
                </div>
              </div>
            </div>
          );
        };

        const ValueDisplay = ({ copper }) => {
          const parts = formatMoney(copper);
          if (Array.isArray(parts)) {
              return (
                <div className="inline-flex items-center gap-1.5 bg-black/30 px-2 py-1 rounded-md border border-white/5 min-w-fit">
                    {parts.map((p, idx) => (
                        <span key={idx} className={`flex items-baseline gap-0.5 text-[10px] font-bold ${p.color}`}>
                            {p.val}<span className="text-[1em] uppercase opacity-70 tracking-tighter">{p.unit}</span>
                        </span>
                    ))}
                </div>
              )
          }
          return null;
        };

        const HistoryItem = ({ item, isExpanded, onToggle, isRollingView = false }) => {
          const rarityKey = normalizeRarity(item.rarity);
          const rarityClass = RARITY_COLORS[rarityKey] || RARITY_COLORS["Common"];
          const rarityBgDot = RARITY_BG_DOT[rarityKey] || RARITY_BG_DOT["Common"];
          const rarityTextColor = RARITY_TEXT_COLORS[rarityKey] || RARITY_TEXT_COLORS["Common"];

          return (
            <div 
              className={`
                relative w-full rounded-xl border backdrop-blur-sm overflow-hidden transition-all duration-300
                ${isRollingView 
                    ? `${rarityClass} border-opacity-50 bg-opacity-20 opacity-80`
                    : isExpanded 
                        ? `${rarityClass} border-opacity-40 bg-opacity-10 shadow-lg scale-[1.01] z-10` 
                        : 'bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20 cursor-pointer'
                }
                ${item.isNew ? 'animate-flash' : ''}
              `}
              onClick={!isExpanded && !isRollingView ? onToggle : undefined}
            >
              <div className="p-3 md:p-4 flex items-center justify-between cursor-pointer gap-4" onClick={isExpanded && !isRollingView ? onToggle : undefined}>
                <div className="flex items-center gap-3 overflow-hidden flex-1 min-w-0">
                  <div className={`w-2 h-2 rounded-full shrink-0 ${rarityBgDot}`} />
                  <span className={`font-semibold text-sm md:text-base truncate transition-colors ${isRollingView ? 'text-white/50' : rarityTextColor}`}>
                    {item.name}
                  </span>
                </div>
                {!isRollingView && (
                    <div className="flex items-center gap-3 shrink-0 animate-fade-in-up">
                    {item.value > 0 && <ValueDisplay copper={item.value} />}
                    <span className={`hidden sm:inline-flex px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${rarityTextColor} bg-white/5 border border-white/5`}>
                        {rarityKey}
                    </span>
                    <div className={`text-white/30 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}><ChevronDown className="w-4 h-4" /></div>
                    </div>
                )}
              </div>
              <div className={`overflow-hidden transition-[max-height] duration-500 ease-in-out ${isExpanded && !isRollingView ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                <div className="px-4 pb-4 pt-0">
                    <div className="h-px w-full bg-white/5 mb-3"></div>
                    <div className="sm:hidden mb-2"><span className={`text-[10px] font-bold uppercase tracking-wider opacity-60 ${rarityTextColor}`}>{rarityKey}</span></div>
                    <p className="text-sm leading-relaxed text-slate-300 font-medium">{item.description}</p>
                    <div className="mt-3 flex justify-end"><span className="text-[10px] text-white/20 uppercase tracking-widest">{item.category}</span></div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>